<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ëª¨ë¹„ë…¸ê¸° ìƒí™œ ìˆ™ì œí‘œ</title>
    <style>
        /* =========================================
           [ìŠ¤íƒ€ì¼ ì‹œíŠ¸] ë…ë¦½í˜• CSS
           ========================================= */
        :root {
            --primary: #4f46e5;
            /* ë³´ë¼ */
            --primary-bg: #eef2ff;
            --secondary: #10b981;
            /* ì´ˆë¡ */
            --bg-color: #f3f4f6;
            --white: #ffffff;
            --border: #e5e7eb;
            --text-main: #111827;
            --text-sub: #6b7280;
            --header-h: 70px;
            --tabs-h: 54px;
        }

        body {
            font-family: 'Apple SD Gothic Neo', 'Noto Sans KR', sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            padding: 20px;
            color: var(--text-main);
            padding-top: 0;
            padding-bottom: 120px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background-color: var(--white);
            border-radius: 16px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            min-height: 90vh;
        }

        /* í—¤ë” */
        .header {
            background-color: var(--primary);
            color: white;
            height: var(--header-h);
            padding: 0 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-sizing: border-box;
        }

        .header h1 {
            margin: 0;
            font-size: 1.4rem;
            font-weight: 800;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .header p {
            margin: 0;
            font-size: 0.85rem;
            opacity: 0.9;
            margin-left: 12px;
            display: inline-block;
        }

        .reset-btn {
            background-color: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.4);
            color: white;
            padding: 6px 14px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.85rem;
            transition: 0.2s;
        }

        .reset-btn:hover {
            background-color: rgba(255, 255, 255, 0.3);
        }

        /* íƒ­ */
        .tabs {
            display: flex;
            background: white;
            border-bottom: 1px solid var(--border);
            height: var(--tabs-h);
            position: sticky;
            top: var(--header-h);
            z-index: 900;
            box-sizing: border-box;
            overflow-x: auto;
        }

        .tab-btn {
            flex: 1;
            text-align: center;
            border: none;
            background: none;
            font-weight: bold;
            color: var(--text-sub);
            cursor: pointer;
            border-bottom: 4px solid transparent;
            font-size: 0.95rem;
            line-height: var(--tabs-h);
            padding: 0 10px;
            white-space: nowrap;
        }

        .tab-btn.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
            background-color: var(--primary-bg);
        }

        /* ì„¹ì…˜ */
        .section {
            display: none;
            padding-bottom: 40px;
        }

        .section.active {
            display: block;
        }

        .section-header {
            padding: 16px 24px;
            background-color: #f9fafb;
            border-bottom: 1px solid var(--border);
            font-weight: 800;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            user-select: none;
        }

        .section-header::after {
            content: 'â–¼';
            font-size: 0.8rem;
            transition: 0.3s;
            margin-left: 10px;
        }

        .section-header.collapsed::after {
            transform: rotate(-90deg);
        }

        .section-content {
            transition: max-height 0.3s ease-out;
            overflow: hidden;
        }

        .section-header.collapsed+.section-content {
            display: none;
        }

        /* ë©”ë‰´ ì„¤ì • ì˜ì—­ */
        .menu-config-area {
            padding: 20px;
            background-color: #fffbeb;
            border-bottom: 1px solid #fcd34d;
        }

        .menu-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .menu-group-title {
            font-size: 0.8rem;
            font-weight: 800;
            color: #b45309;
            text-transform: uppercase;
        }

        .add-menu-btn {
            background-color: #f59e0b;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .add-menu-btn:hover {
            background-color: #d97706;
        }

        .toggle-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 10px;
        }

        .toggle-item {
            display: flex;
            align-items: center;
            gap: 8px;
            background: white;
            padding: 8px 10px;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
            cursor: pointer;
            transition: 0.2s;
        }

        .toggle-item.active {
            border-color: #f59e0b;
            background-color: #fff7ed;
        }

        .toggle-switch {
            width: 32px;
            height: 18px;
            background-color: #d1d5db;
            border-radius: 20px;
            position: relative;
            transition: 0.3s;
        }

        .toggle-item.active .toggle-switch {
            background-color: #f59e0b;
        }

        .toggle-dot {
            width: 14px;
            height: 14px;
            background: white;
            border-radius: 50%;
            position: absolute;
            top: 2px;
            left: 2px;
            transition: 0.3s;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }

        .toggle-item.active .toggle-dot {
            left: 16px;
        }

        .edit-menu-btn {
            background: none;
            border: none;
            color: #9ca3af;
            cursor: pointer;
            padding: 2px;
            font-size: 0.9rem;
            transition: 0.2s;
            display: none;
            /* Hide by default, will show in manager */
            align-items: center;
            justify-content: center;
        }

        .toggle-item {
            display: flex;
            align-items: center;
            gap: 12px;
            background: white;
            padding: 10px 14px;
            border-radius: 10px;
            border: 1px solid #e5e7eb;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            user-select: none;
        }

        .toggle-label {
            font-size: 0.9rem;
            font-weight: 700;
            color: #374151;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            flex-grow: 1;
        }

        .row-actions {
            display: flex;
            gap: 8px;
            opacity: 0.2;
            /* ìƒì‹œ ë…¸ì¶œë¡œ ë³€ê²½ (ë‚®ì€ íˆ¬ëª…ë„) */
            transition: 0.2s;
            margin-left: auto;
            pointer-events: auto;
            z-index: 100;
        }

        tr:hover .row-actions {
            opacity: 1;
        }

        .action-btn {
            background-color: #f3f4f6;
            border: 1px solid #e5e7eb;
            cursor: pointer;
            font-size: 1.1rem;
            padding: 6px;
            border-radius: 6px;
            line-height: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: 0.2s;
        }

        .action-btn:hover {
            transform: scale(1.1);
        }

        .btn-edit {
            color: #4f46e5;
        }

        .btn-edit:hover {
            background-color: #eef2ff;
            border-color: #4f46e5;
        }

        .drag-handle {
            cursor: grab;
            color: #d1d5db;
            padding: 0 8px 0 4px;
            font-size: 0.9rem;
            user-select: none;
        }

        .drag-handle:active {
            cursor: grabbing;
        }

        tr.dragging {
            opacity: 0.5;
            background-color: #f1f5f9;
        }

        tr.drag-over {
            border-top: 2px solid var(--primary);
        }

        .add-row-btn,
        .del-row-btn {
            color: white;
            border: none;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: bold;
            cursor: pointer;
            margin-left: 6px;
        }

        .add-row-btn {
            background-color: #4f46e5;
        }

        .add-row-btn:hover {
            background-color: #3730a3;
        }

        .del-row-btn {
            background-color: #ef4444;
        }

        .del-row-btn:hover {
            background-color: #dc2626;
        }

        /* ë§¤ë‹ˆì € ëª¨ë‹¬ ë¦¬ìŠ¤íŠ¸ */
        .manage-list {
            margin-top: 10px;
            max-height: 300px;
            overflow-y: auto;
            border-top: 1px solid #e5e7eb;
        }

        .manage-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #f3f4f6;
        }

        .manage-item-info {
            font-size: 0.85rem;
        }

        .manage-item-info b {
            color: #111827;
        }

        .manage-item-info span {
            color: #6b7280;
            display: block;
            font-size: 0.75rem;
        }

        .btn-mini-del {
            background-color: #fee2e2;
            color: #ef4444;
            border: 1px solid #fecaca;
            border-radius: 4px;
            padding: 2px 8px;
            font-size: 0.7rem;
            font-weight: bold;
            cursor: pointer;
        }

        .btn-mini-del:hover {
            background-color: #fca5a5;
            color: white;
        }

        .npc-container {
            display: flex;
            align-items: center;
        }

        .npc-info {
            flex-grow: 1;
        }

        /* ì¤€ë¹„ ì¹´ë“œ ê·¸ë¦¬ë“œ */
        .special-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 12px;
            padding: 20px;
        }

        .char-divider {
            padding: 8px 24px;
            background-color: #f3f4f6;
            font-size: 0.9rem;
            font-weight: 800;
            color: #4b5563;
            border-top: 1px solid #e5e7eb;
            border-bottom: 1px solid #e5e7eb;
            margin-top: 0;
        }

        .card {
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: white;
            position: relative;
        }

        .card-actions {
            position: absolute;
            top: 4px;
            right: 4px;
            display: none;
            gap: 4px;
        }

        .card:hover .card-actions {
            display: flex;
        }

        .card-action-btn {
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid #e5e7eb;
            border-radius: 4px;
            padding: 2px 4px;
            font-size: 0.7rem;
            cursor: pointer;
            transition: 0.2s;
        }

        .card-action-btn:hover {
            background: #f3f4f6;
            border-color: var(--primary);
        }

        .card:hover {
            transform: translateY(-2px);
            border-color: var(--primary);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }

        .card.checked {
            background-color: #f0fdf4;
            border-color: var(--secondary);
        }

        .card-content h3 {
            margin: 0 0 4px 0;
            font-size: 0.95rem;
            color: var(--text-main);
        }

        .card-content p {
            margin: 0;
            font-size: 0.8rem;
            color: var(--text-sub);
        }

        .prep-check-circle {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 2px solid #d1d5db;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 1rem;
            transition: 0.2s;
            flex-shrink: 0;
            margin-left: 10px;
        }

        .card.checked .prep-check-circle {
            background-color: var(--secondary);
            border-color: var(--secondary);
        }

        .card.checked .prep-check-circle::after {
            content: 'âœ“';
        }

        /* ë©”ëª¨ì¥ */
        .memo-box {
            margin: 20px;
            padding: 16px;
            background-color: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
        }

        .memo-label {
            font-weight: 800;
            color: #4b5563;
            margin-bottom: 8px;
            display: block;
            font-size: 0.9rem;
        }

        .memo-textarea {
            width: 100%;
            height: 120px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            padding: 12px;
            font-size: 0.9rem;
            resize: vertical;
            background-color: white;
            box-sizing: border-box;
        }

        .memo-textarea:focus {
            outline: 2px solid var(--primary);
            border-color: transparent;
        }

        /* í…Œì´ë¸” */
        .table-wrap {
            overflow-x: auto;
            max-height: calc(100vh - 200px);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 600px;
            table-layout: fixed;
        }

        th {
            background-color: #f9fafb;
            color: var(--text-sub);
            font-size: 0.8rem;
            text-transform: uppercase;
            padding: 10px;
            text-align: center;
            border-bottom: 2px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 800;
            box-shadow: 0 2px 2px -1px rgba(0, 0, 0, 0.05);
        }

        th:first-child {
            text-align: left;
            padding-left: 24px;
            width: 40%;
            z-index: 850;
        }

        td:first-child {
            text-align: left;
            padding-left: 24px;
            width: 40%;
            border-right: 1px solid #f3f4f6;
            position: sticky;
            left: 0;
            background: white;
            z-index: 10;
        }

        th:not(:first-child),
        td:not(:first-child) {
            width: 12%;
        }

        .village-row td {
            background-color: #f1f5f9;
            font-weight: 800;
            font-size: 0.85rem;
            color: var(--text-main);
            padding: 8px 24px;
            border-top: 1px solid var(--border);
            border-bottom: 1px solid var(--border);
        }

        td {
            padding: 12px 8px;
            border-bottom: 1px solid #f3f4f6;
            vertical-align: middle;
        }

        .npc-name {
            font-weight: 800;
            font-size: 0.95rem;
            color: var(--text-main);
            margin-bottom: 2px;
        }

        .item-desc {
            font-size: 0.8rem;
            color: var(--text-sub);
            line-height: 1.4;
            word-break: keep-all;
        }

        .name-input {
            width: 100%;
            border: 1px solid transparent;
            background: transparent;
            text-align: center;
            font-weight: 800;
            font-size: 0.85rem;
            color: var(--text-main);
            padding: 4px;
            border-radius: 4px;
        }

        .name-input:hover,
        .name-input:focus {
            background: white;
            border-color: var(--primary);
            outline: none;
        }

        .role-select {
            display: block;
            margin-top: 4px;
            font-size: 0.75rem;
            padding: 2px 4px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            color: #4b5563;
            background-color: #f9fafb;
            width: 100%;
            max-width: 120px;
        }

        .check-cell {
            cursor: pointer;
            text-align: center;
        }

        .check-cell:hover {
            background-color: #f9fafb;
        }

        .check-box {
            width: 24px;
            height: 24px;
            border: 2px solid #d1d5db;
            border-radius: 6px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 16px;
            transition: 0.2s;
        }

        .check-cell.checked .check-box {
            background-color: var(--secondary);
            border-color: var(--secondary);
        }

        .check-cell.checked .check-box::after {
            content: 'âœ“';
        }

        /* ëª¨ë‹¬ (íŒì—…) ìŠ¤íƒ€ì¼ */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.open {
            display: flex;
        }

        .modal {
            background: white;
            width: 90%;
            max-width: 550px;
            border-radius: 12px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            animation: modalIn 0.2s ease-out;
            display: flex;
            flex-direction: column;
            max-height: 90vh;
        }

        @keyframes modalIn {
            from {
                transform: scale(0.95);
                opacity: 0;
            }

            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        .modal-header {
            padding: 16px 20px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f9fafb;
        }

        .modal-title {
            font-weight: 800;
            color: #111827;
            font-size: 1.1rem;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #6b7280;
            line-height: 1;
        }

        .modal-body {
            padding: 20px;
            overflow-y: auto;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            font-size: 0.85rem;
            font-weight: 700;
            color: #374151;
            margin-bottom: 6px;
        }

        .form-input,
        .form-select {
            width: 100%;
            padding: 10px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 0.9rem;
            box-sizing: border-box;
        }

        /* í¼ ê·¸ë¦¬ë“œ (Row Layout) */
        .form-row-4 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr;
            gap: 8px;
        }

        .form-row-2-3-1 {
            display: grid;
            grid-template-columns: 3fr 1fr;
            gap: 8px;
        }

        /* ì¬ë£Œ ì¶”ê°€ CSS */
        .ing-row {
            display: flex;
            gap: 6px;
            margin-bottom: 8px;
            align-items: center;
            flex-wrap: wrap;
        }

        .ing-name {
            flex: 2;
            min-width: 80px;
        }

        .ing-qty {
            width: 50px;
            text-align: center;
        }

        .ing-type {
            width: 65px;
            padding: 8px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 0.85rem;
        }

        .ing-village {
            width: 90px;
        }

        .ing-npc {
            width: 70px;
        }

        .ing-row input,
        .ing-row select {
            padding: 8px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 0.85rem;
        }

        .ing-btn-del {
            color: #ef4444;
            background: none;
            border: none;
            cursor: pointer;
            font-weight: bold;
            padding: 4px;
        }

        .add-ing-btn {
            background-color: #f3f4f6;
            color: #4b5563;
            border: 1px dashed #d1d5db;
            width: 100%;
            padding: 8px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: bold;
        }

        .add-ing-btn:hover {
            background-color: #e5e7eb;
        }

        .modal-footer {
            padding: 16px 20px;
            border-top: 1px solid #e5e7eb;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            background: #f9fafb;
        }

        .btn-cancel {
            padding: 8px 16px;
            border: 1px solid #d1d5db;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            color: #374151;
        }

        .btn-submit {
            padding: 8px 16px;
            border: none;
            background: #4f46e5;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            color: white;
        }

        /* ëª¨ë°”ì¼ ëŒ€ì‘ */
        @media (max-width: 600px) {
            :root {
                --header-h: 100px;
                --tabs-h: 50px;
            }

            .header {
                flex-direction: column;
                align-items: flex-start;
                justify-content: center;
                gap: 8px;
                padding: 16px;
            }

            .reset-btn {
                position: absolute;
                right: 20px;
                top: 20px;
            }

            th {
                font-size: 0.7rem;
                padding: 8px 4px;
            }

            .name-input {
                font-size: 0.75rem;
            }

            th:first-child,
            td:first-child {
                width: 45%;
                padding-left: 12px;
            }

            td:not(:first-child) {
                width: 11%;
            }

            .ing-row {
                gap: 4px;
            }

            .form-row-4 {
                grid-template-columns: 1fr 1fr;
            }

            /* ëª¨ë°”ì¼ì—ì„  2x2 */
        }

        /* ë‹´ë‹¹ ì„¤ì • ë²„íŠ¼ ë° íŒì—… ìŠ¤íƒ€ì¼ */
        .role-btn {
            display: block;
            margin-top: 8px;
            font-size: 0.75rem;
            padding: 4px 8px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            color: #4f46e5;
            background-color: #f5f3ff;
            cursor: pointer;
            font-weight: bold;
            transition: 0.2s;
        }

        .role-btn:hover {
            background-color: #ede9fe;
            border-color: #4f46e5;
        }

        .role-popup {
            position: absolute;
            background: white;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 3000;
            padding: 8px;
            display: none;
            min-width: 120px;
        }

        .role-popup.show {
            display: block;
        }

        .role-option {
            padding: 6px 10px;
            font-size: 0.85rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            border-radius: 4px;
        }

        .role-option:hover {
            background-color: #f3f4f6;
        }

        .role-option input {
            margin: 0;
        }

        /* Shake animation for validation errors */
        @keyframes shake {

            0%,
            100% {
                transform: translateX(0);
            }

            10%,
            30%,
            50%,
            70%,
            90% {
                transform: translateX(-10px);
            }

            20%,
            40%,
            60%,
            80% {
                transform: translateX(10px);
            }
        }
    </style>
</head>

<body>

    <div class="container">
        <div class="header">
            <div>
                <h1>ğŸ“… ëª¨ë¹„ë…¸ê¸° ìƒí™œ ìˆ™ì œí‘œ</h1>
                <p>ë©”ë‰´ ì„¤ì • â†’ ìš”ë¦¬ â†’ êµ¬ë§¤ â†’ êµí™˜</p>
            </div>
            <div style="display:flex; gap:10px;">
                <button class="reset-btn" style="background-color:#4b5563;" onclick="openCharManager()">ğŸ‘¥ ìºë¦­í„°
                    ì„¤ì •</button>
                <button class="reset-btn" onclick="resetAll()">ğŸ—‘ï¸ ì´ˆê¸°í™”</button>
            </div>
        </div>

        <div class="tabs">
            <button class="tab-btn active" onclick="showSection('special', this)">â­ ì¤€ë¹„&ë©”ë‰´</button>
            <button class="tab-btn" onclick="showSection('cooking', this)">ğŸ³ ìš”ë¦¬ì œì‘</button>
            <button class="tab-btn" onclick="showSection('shopping', this)">ğŸ›ï¸ ì£¼ê°„êµ¬ë§¤</button>
            <button class="tab-btn" onclick="showSection('weekly', this)">ğŸ“¦ ì£¼ê°„êµí™˜</button>
            <button class="tab-btn" onclick="showSection('daily', this)">ğŸ”„ ì¼ì¼êµí™˜</button>
        </div>

        <!-- 0. ì¤€ë¹„ & ë©”ë‰´ -->
        <div id="special" class="section sec-special active">
            <div class="menu-config-area">
                <div class="menu-header" style="justify-content: space-between; align-items:center;">
                    <div class="menu-group-title" style="margin:0;">â˜€ï¸ DAILY & ğŸ—“ï¸ WEEKLY ë©”ë‰´</div>
                    <button class="btn-mini-del"
                        style="background:#e5e7eb; color:#374151; padding:2px 6px; font-size:0.75rem; border:1px solid #d1d5db;"
                        onclick="openMenuManager()">âš™ï¸ ê´€ë¦¬</button>
                </div>
                <div class="menu-group-title" style="margin-bottom:8px; opacity:0.6; font-size:0.7rem;">â˜€ï¸ DAILY</div>
                <div class="toggle-grid" id="menu-toggles-daily"></div>
                <div style="height:16px;"></div>
                <div class="menu-group-title" style="margin-bottom:8px; opacity:0.6; font-size:0.7rem; color: #4f46e5;">
                    ğŸ—“ï¸ WEEKLY</div>
                <div class="toggle-grid" id="menu-toggles-weekly"></div>
            </div>

            <div class="section-header" onclick="toggleSection(this)">
                ğŸ¥ª ê³µí†µ ì¤€ë¹„ë¬¼
                <button class="add-menu-btn" style="background-color:#4b5563;"
                    onclick="event.stopPropagation(); openCommonPrepModal()">â•
                    ì¶”ê°€</button>
            </div>
            <div class="section-content">
                <div id="common-prep-area" class="special-grid" style="padding: 10px 20px;"></div>
            </div>

            <div class="section-header" onclick="toggleSection(this)">ğŸ‘‘ ì¶”ê°€ ì¤€ë¹„ë¬¼ (ë©”ë‰´/ë‹´ë‹¹ ì—°ë™)</div>
            <div class="section-content">
                <div id="dynamic-prep-area"></div>
            </div>

            <div class="section-header" onclick="toggleSection(this)">ğŸ“ ë©”ëª¨ì¥</div>
            <div class="section-content">
                <div class="memo-box">
                    <label class="memo-label">ğŸ“ ì¤€ë¹„ë¬¼ ë©”ëª¨ (ìë™ ì €ì¥)</label>
                    <textarea id="tab-memo" class="memo-textarea" placeholder="ì—¬ê¸°ì— í•„ìš”í•œ ë‚´ìš©ì„ ë©”ëª¨í•˜ì„¸ìš”..."
                        oninput="saveTabMemo(this.value)"></textarea>
                </div>
            </div>
        </div>

        <!-- 1. ìš”ë¦¬ ì œì‘ -->
        <div id="cooking" class="section sec-cooking">
            <div class="section-header">ğŸ³ ìš”ë¦¬ ì œì‘ & ë‹´ë‹¹ ì„¤ì •</div>
            <div class="table-wrap">
                <table id="table-cooking">
                    <tbody id="body-cooking"></tbody>
                </table>
            </div>
        </div>

        <!-- 2. ì£¼ê°„ êµ¬ë§¤ -->
        <div id="shopping" class="section sec-shop">
            <div class="section-header">
                ğŸ›ï¸ ì£¼ê°„ ìƒì  êµ¬ë§¤
                <span></span>
            </div>
            <div class="table-wrap">
                <table id="table-shopping">
                    <tbody id="body-shopping"></tbody>
                </table>
            </div>
        </div>

        <!-- 3. ì£¼ê°„ êµí™˜ -->
        <div id="weekly" class="section sec-week">
            <div class="section-header">
                ğŸ“¦ ì£¼ê°„ ë¬¼ë¬¼êµí™˜
                <span></span>
            </div>
            <div class="table-wrap">
                <table id="table-weekly">
                    <tbody id="body-weekly"></tbody>
                </table>
            </div>
        </div>

        <!-- 4. ì¼ì¼ êµí™˜ -->
        <div id="daily" class="section sec-day">
            <div class="section-header">
                ğŸ”„ ì¼ì¼ ë¬¼ë¬¼êµí™˜
                <span></span>
            </div>
            <div class="table-wrap">
                <table id="table-daily">
                    <tbody id="body-daily"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- ëª¨ë‹¬ ì°½ -->
    <div id="add-modal" class="modal-overlay" style="z-index: 2100;">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title" id="modal-title">â• ìƒˆ ë©”ë‰´ ì¶”ê°€</div>
                <input type="hidden" id="edit-tag-id" value="">
                <button class="close-btn" onclick="closeModal()">Ã—</button>
            </div>
            <div class="modal-body">
                <!-- 1. ë©”ë‰´ ê¸°ë³¸ ì •ë³´ -->
                <div class="form-group">
                    <label class="form-label">ë©”ë‰´ ì´ë¦„ (í•„ìˆ˜)</label>
                    <input type="text" id="add-menu-name" class="form-input" placeholder="ì˜ˆ: ì–‘í„¸ê¹ê¸°">
                </div>

                <!-- í•œ í–‰ì— ë°°ì¹˜: êµí™˜ì£¼ê¸° | ëˆ„êµ¬ì—ê²Œ | ë§ˆì„ | ì¤„ ê°œìˆ˜ -->
                <div class="form-row-4 form-group">
                    <div>
                        <label class="form-label">êµí™˜ ì£¼ê¸°</label>
                        <select id="add-cycle" class="form-select">
                            <option value="weekly">ì£¼ê°„ êµí™˜</option>
                            <option value="daily">ì¼ì¼ êµí™˜</option>
                        </select>
                    </div>
                    <div>
                        <label class="form-label">ëˆ„êµ¬ì—ê²Œ</label>
                        <input type="text" id="add-npc" class="form-input" placeholder="NPC">
                    </div>
                    <div>
                        <label class="form-label">ë§ˆì„</label>
                        <select id="add-village" class="form-select">
                            <option value="ì´ë©˜ë§ˆí•˜">ì´ë©˜ë§ˆí•˜</option>
                            <option value="ë°˜í˜¸ë¥´">ë°˜í˜¸ë¥´</option>
                            <option value="ë˜ë°”íŠ¼">ë˜ë°”íŠ¼</option>
                            <option value="í‹°ë¥´ì½”ë„¤ì¼">í‹°ë¥´ì½”ë„¤ì¼</option>
                            <option value="ì½œí—¨">ì½œí—¨</option>
                            <option value="ë‘ê°ˆë“œì•„ì¼">ë‘ê°ˆë“œì•„ì¼</option>
                            <option value="ê¸°íƒ€">ê¸°íƒ€</option>
                        </select>
                    </div>
                    <div>
                        <label class="form-label">ì¤„ ê°œìˆ˜</label>
                        <input type="text" id="add-give-qty" class="form-input" placeholder="0">
                    </div>
                </div>

                <!-- í•œ í–‰ì— ë°°ì¹˜: ë°›ì„ ë³´ìƒ | ë°›ëŠ” ê°œìˆ˜ -->
                <div class="form-row-2-3-1 form-group">
                    <div>
                        <label class="form-label">ë°›ì„ ë³´ìƒ (ì•„ì´í…œëª…)</label>
                        <input type="text" id="add-reward" class="form-input" placeholder="ì˜ˆ: ìµœê³ ê¸‰ ê°€ì£½">
                    </div>
                    <div>
                        <label class="form-label">ê°œìˆ˜</label>
                        <input type="text" id="add-reward-qty" class="form-input" placeholder="1">
                    </div>
                </div>

                <!-- 2. ì¬ë£Œ ì…ë ¥ -->
                <div style="border-top:1px dashed #e5e7eb; margin:16px 0; padding-top:16px;">
                    <label class="form-label">ğŸ¥˜ ì¬ë£Œ ì¶”ê°€ (ë ˆì‹œí”¼)</label>
                    <p style="font-size:0.75rem; color:#6b7280; margin-bottom:8px;">* ë™ì¼í•œ ë©”ë‰´ ì´ë¦„ìœ¼ë¡œ ì´ë¯¸ ì €ì¥ëœ í•­ëª©ì´ ìˆë‹¤ë©´ í•´ë‹¹ ì¬ë£Œë“¤ì´
                        í•©ì‚°ë˜ì–´ í‘œì‹œë©ë‹ˆë‹¤.</p>

                    <div id="ing-list"></div>
                    <button type="button" class="add-ing-btn" onclick="addIngRow()">+ ì¬ë£Œ í•œ ì¤„ ì¶”ê°€</button>
                </div>

            </div>
            <div class="modal-footer">
                <button class="btn-cancel" onclick="closeModal()">ì·¨ì†Œ</button>
                <button class="btn-submit" onclick="addItem()">ì €ì¥í•˜ê¸°</button>
            </div>
        </div>
    </div>

    <!-- ì¤€ë¹„ë¬¼ í¸ì§‘ ëª¨ë‹¬ -->
    <div id="prep-modal" class="modal-overlay">
        <div class="modal" style="max-width:350px;">
            <div class="modal-header">
                <div class="modal-title">ğŸ“¦ ì¤€ë¹„ë¬¼ í¸ì§‘</div>
                <button class="close-btn" onclick="closePrepModal()">Ã—</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="edit-prep-id">
                <input type="hidden" id="edit-prep-type">
                <div class="form-group" id="prep-title-group">
                    <label class="form-label">ì¤€ë¹„ë¬¼ ì œëª©</label>
                    <input type="text" id="prep-title" class="form-input">
                </div>
                <div class="form-group">
                    <label class="form-label">ì„¤ëª…</label>
                    <input type="text" id="prep-desc" class="form-input">
                </div>
                <div class="form-group" id="prep-icon-group">
                    <label class="form-label">ì•„ì´ì½˜ ë³´ì •</label>
                    <div style="display:flex; flex-wrap:wrap; gap:5px; margin-bottom:10px;" id="icon-picker">
                        <button type="button" class="action-btn" style="padding:4px; font-size:1rem;"
                            onclick="setPrepIcon('ğŸ“œ')">ğŸ“œ</button>
                        <button type="button" class="action-btn" style="padding:4px; font-size:1rem;"
                            onclick="setPrepIcon('ğŸŒ¿')">ğŸŒ¿</button>
                        <button type="button" class="action-btn" style="padding:4px; font-size:1rem;"
                            onclick="setPrepIcon('ğŸ”¨')">ğŸ”¨</button>
                        <button type="button" class="action-btn" style="padding:4px; font-size:1rem;"
                            onclick="setPrepIcon('ğŸ›’')">ğŸ›’</button>
                        <button type="button" class="action-btn" style="padding:4px; font-size:1rem;"
                            onclick="setPrepIcon('ğŸ“œ')">ğŸ“œ</button>
                        <button type="button" class="action-btn" style="padding:4px; font-size:1rem;"
                            onclick="setPrepIcon('ğŸ› ï¸')">ğŸ› ï¸</button>
                        <button type="button" class="action-btn" style="padding:4px; font-size:1rem;"
                            onclick="setPrepIcon('ğŸ“¦')">ğŸ“¦</button>
                        <button type="button" class="action-btn" style="padding:4px; font-size:1rem;"
                            onclick="setPrepIcon('ğŸ›’')">ğŸ›’</button>
                        <button type="button" class="action-btn" style="padding:4px; font-size:1rem;"
                            onclick="setPrepIcon('ğŸ”¨')">ğŸ”¨</button>
                        <button type="button" class="action-btn" style="padding:4px; font-size:1rem;"
                            onclick="setPrepIcon('âœ‚ï¸')">âœ‚ï¸</button>
                        <button type="button" class="action-btn" style="padding:4px; font-size:1rem;"
                            onclick="setPrepIcon('ğŸ§¶')">ğŸ§¶</button>

                        <button type="button" class="action-btn" style="padding:4px; font-size:1rem;"
                            onclick="setPrepIcon('ğŸŒ¿')">ğŸŒ¿</button>
                        <button type="button" class="action-btn" style="padding:4px; font-size:1rem;"
                            onclick="setPrepIcon('ğŸƒ')">ğŸƒ</button>
                        <button type="button" class="action-btn" style="padding:4px; font-size:1rem;"
                            onclick="setPrepIcon('ğŸªµ')">ğŸªµ</button>
                        <button type="button" class="action-btn" style="padding:4px; font-size:1rem;"
                            onclick="setPrepIcon('ğŸ¥¬')">ğŸ¥¬</button>
                        <button type="button" class="action-btn" style="padding:4px; font-size:1rem;"
                            onclick="setPrepIcon('ğŸ¥•')">ğŸ¥•</button>
                        <button type="button" class="action-btn" style="padding:4px; font-size:1rem;"
                            onclick="setPrepIcon('ğŸ§…')">ğŸ§…</button>
                        <button type="button" class="action-btn" style="padding:4px; font-size:1rem;"
                            onclick="setPrepIcon('ğŸ§„')">ğŸ§„</button>
                        <button type="button" class="action-btn" style="padding:4px; font-size:1rem;"
                            onclick="setPrepIcon('ğŸ¥”')">ğŸ¥”</button>
                        <button type="button" class="action-btn" style="padding:4px; font-size:1rem;"
                            onclick="setPrepIcon('ğŸ ')">ğŸ </button>
                        <button type="button" class="action-btn" style="padding:4px; font-size:1rem;"
                            onclick="setPrepIcon('ğŸ«š')">ğŸ«š</button>
                        <button type="button" class="action-btn" style="padding:4px; font-size:1rem;"
                            onclick="setPrepIcon('ğŸ¥¦')">ğŸ¥¦</button>
                        <button type="button" class="action-btn" style="padding:4px; font-size:1rem;"
                            onclick="setPrepIcon('ğŸŒ½')">ğŸŒ½</button>
                        <button type="button" class="action-btn" style="padding:4px; font-size:1rem;"
                            onclick="setPrepIcon('ğŸ„')">ğŸ„</button>
                        <button type="button" class="action-btn" style="padding:4px; font-size:1rem;"
                            onclick="setPrepIcon('ğŸ¥œ')">ğŸ¥œ</button>
                        <button type="button" class="action-btn" style="padding:4px; font-size:1rem;"
                            onclick="setPrepIcon('ğŸŒ°')">ğŸŒ°</button>
                        <button type="button" class="action-btn" style="padding:4px; font-size:1rem;"
                            onclick="setPrepIcon('ğŸ¥‘')">ğŸ¥‘</button>
                        <button type="button" class="action-btn" style="padding:4px; font-size:1rem;"
                            onclick="setPrepIcon('ğŸƒ')">ğŸƒ</button>
                        <button type="button" class="action-btn" style="padding:4px; font-size:1rem;"
                            onclick="setPrepIcon('ğŸŒ¶ï¸')">ğŸŒ¶ï¸</button>
                        <button type="button" class="action-btn" style="padding:4px; font-size:1rem;"
                            onclick="setPrepIcon('ğŸ“')">ğŸ“</button>
                        <button type="button" class="action-btn" style="padding:4px; font-size:1rem;"
                            onclick="setPrepIcon('ğŸ')">ğŸ</button>

                        <button type="button" class="action-btn" style="padding:4px; font-size:1rem;"
                            onclick="setPrepIcon('ğŸ–')">ğŸ–</button>
                        <button type="button" class="action-btn" style="padding:4px; font-size:1rem;"
                            onclick="setPrepIcon('ğŸ¥©')">ğŸ¥©</button>
                        <button type="button" class="action-btn" style="padding:4px; font-size:1rem;"
                            onclick="setPrepIcon('ğŸ—')">ğŸ—</button>
                        <button type="button" class="action-btn" style="padding:4px; font-size:1rem;"
                            onclick="setPrepIcon('ğŸ¥“')">ğŸ¥“</button>
                        <button type="button" class="action-btn" style="padding:4px; font-size:1rem;"
                            onclick="setPrepIcon('ğŸ¥š')">ğŸ¥š</button>
                        <button type="button" class="action-btn" style="padding:4px; font-size:1rem;"
                            onclick="setPrepIcon('ğŸŸ')">ğŸŸ</button>
                        <button type="button" class="action-btn" style="padding:4px; font-size:1rem;"
                            onclick="setPrepIcon('ğŸ£')">ğŸ£</button>

                        <button type="button" class="action-btn" style="padding:4px; font-size:1rem;"
                            onclick="setPrepIcon('ğŸ')">ğŸ</button>
                        <button type="button" class="action-btn" style="padding:4px; font-size:1rem;"
                            onclick="setPrepIcon('ğŸ§€')">ğŸ§€</button>
                        <button type="button" class="action-btn" style="padding:4px; font-size:1rem;"
                            onclick="setPrepIcon('ğŸ¥›')">ğŸ¥›</button>
                        <button type="button" class="action-btn" style="padding:4px; font-size:1rem;"
                            onclick="setPrepIcon('ğŸ§')">ğŸ§</button>
                        <button type="button" class="action-btn" style="padding:4px; font-size:1rem;"
                            onclick="setPrepIcon('ğŸº')">ğŸº</button>
                        <button type="button" class="action-btn" style="padding:4px; font-size:1rem;"
                            onclick="setPrepIcon('ğŸ·')">ğŸ·</button>
                        <button type="button" class="action-btn" style="padding:4px; font-size:1rem;"
                            onclick="setPrepIcon('ğŸš')">ğŸš</button>
                        <button type="button" class="action-btn" style="padding:4px; font-size:1rem;"
                            onclick="setPrepIcon('ğŸ›')">ğŸ›</button>

                        <button type="button" class="action-btn" style="padding:4px; font-size:1rem;"
                            onclick="setPrepIcon('ğŸ§‚')">ğŸ§‚</button>
                        <button type="button" class="action-btn" style="padding:4px; font-size:1rem;"
                            onclick="setPrepIcon('ğŸº')">ğŸº</button>
                        <button type="button" class="action-btn" style="padding:4px; font-size:1rem;"
                            onclick="setPrepIcon('ğŸ’')">ğŸ’</button>
                        <button type="button" class="action-btn" style="padding:4px; font-size:1rem;"
                            onclick="setPrepIcon('ğŸª™')">ğŸª™</button>
                        <button type="button" class="action-btn" style="padding:4px; font-size:1rem;"
                            onclick="setPrepIcon('ğŸ—ï¸')">ğŸ—ï¸</button>
                        <button type="button" class="action-btn" style="padding:4px; font-size:1rem;"
                            onclick="setPrepIcon('ğŸ©¹')">ğŸ©¹</button>
                        <button type="button" class="action-btn" style="padding:4px; font-size:1rem;"
                            onclick="setPrepIcon('ğŸ§µ')">ğŸ§µ</button>
                    </div>
                </div>
                <div class="form-group" id="prep-color-group">
                    <label class="form-label">í•­ëª© ìƒ‰ìƒ (HEX)</label>
                    <input type="color" id="prep-color" class="form-input" style="height:40px; padding:2px;">
                    <div style="display:flex; flex-wrap:nowrap; gap:3px; margin-top:8px;">
                        <button type="button" class="action-btn"
                            style="padding:2px; width:24px; height:24px; min-width:24px; background:#ef4444; border:2px solid #ddd;"
                            onclick="document.getElementById('prep-color').value='#ef4444'" title="ë¹¨ê°•"></button>
                        <button type="button" class="action-btn"
                            style="padding:2px; width:24px; height:24px; min-width:24px; background:#f97316; border:2px solid #ddd;"
                            onclick="document.getElementById('prep-color').value='#f97316'" title="ì£¼í™©"></button>
                        <button type="button" class="action-btn"
                            style="padding:2px; width:24px; height:24px; min-width:24px; background:#f59e0b; border:2px solid #ddd;"
                            onclick="document.getElementById('prep-color').value='#f59e0b'" title="í™©ê¸ˆ"></button>
                        <button type="button" class="action-btn"
                            style="padding:2px; width:24px; height:24px; min-width:24px; background:#15803d; border:2px solid #ddd;"
                            onclick="document.getElementById('prep-color').value='#15803d'" title="ì´ˆë¡"></button>
                        <button type="button" class="action-btn"
                            style="padding:2px; width:24px; height:24px; min-width:24px; background:#3b82f6; border:2px solid #ddd;"
                            onclick="document.getElementById('prep-color').value='#3b82f6'" title="íŒŒë‘"></button>
                        <button type="button" class="action-btn"
                            style="padding:2px; width:24px; height:24px; min-width:24px; background:#8b5cf6; border:2px solid #ddd;"
                            onclick="document.getElementById('prep-color').value='#8b5cf6'" title="ë³´ë¼"></button>
                        <button type="button" class="action-btn"
                            style="padding:2px; width:24px; height:24px; min-width:24px; background:#ec4899; border:2px solid #ddd;"
                            onclick="document.getElementById('prep-color').value='#ec4899'" title="í•‘í¬"></button>
                        <button type="button" class="action-btn"
                            style="padding:2px; width:24px; height:24px; min-width:24px; background:#b45309; border:2px solid #ddd;"
                            onclick="document.getElementById('prep-color').value='#b45309'" title="ê°ˆìƒ‰"></button>
                        <button type="button" class="action-btn"
                            style="padding:2px; width:24px; height:24px; min-width:24px; background:#6b7280; border:2px solid #ddd;"
                            onclick="document.getElementById('prep-color').value='#6b7280'" title="íšŒìƒ‰"></button>
                        <button type="button" class="action-btn"
                            style="padding:2px; width:24px; height:24px; min-width:24px; background:#374151; border:2px solid #ddd;"
                            onclick="document.getElementById('prep-color').value='#374151'" title="ì§„íšŒìƒ‰"></button>
                    </div>
                </div>
            </div>
            <div class="modal-footer" id="prep-modal-footer">
                <button class="btn-cancel" id="prep-del-btn" onclick="deletePrepItem()">ì‚­ì œ</button>
                <div style="flex-grow:1;"></div>
                <button class="btn-submit" onclick="savePrepEdit()">ìˆ˜ì •ì™„ë£Œ</button>
            </div>
        </div>
    </div>

    <!-- ê°œë³„ í•­ëª© ì¶”ê°€/ìˆ˜ì • ëª¨ë‹¬ -->
    <div id="single-modal" class="modal-overlay" style="z-index: 2100;">
        <div class="modal" style="max-width:400px;">
            <div class="modal-header">
                <div class="modal-title" id="single-modal-title">ğŸ“¦ í•­ëª© í¸ì§‘</div>
                <button class="close-btn" onclick="closeSingleModal()">Ã—</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="edit-type">
                <input type="hidden" id="edit-group-village">
                <input type="hidden" id="edit-row-idx">

                <div class="form-group">
                    <label class="form-label">ë§ˆì„</label>
                    <select id="single-village" class="form-select">
                        <option value="ì´ë©˜ë§ˆí•˜">ì´ë©˜ë§ˆí•˜</option>
                        <option value="ë°˜í˜¸ë¥´">ë°˜í˜¸ë¥´</option>
                        <option value="ë˜ë°”íŠ¼">ë˜ë°”íŠ¼</option>
                        <option value="í‹°ë¥´ì½”ë„¤ì¼">í‹°ë¥´ì½”ë„¤ì¼</option>
                        <option value="ì½œí—¨">ì½œí—¨</option>
                        <option value="ë‘ê°ˆë“œì•„ì¼">ë‘ê°ˆë“œì•„ì¼</option>
                        <option value="ê¸°íƒ€">ê¸°íƒ€</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">NPC ì´ë¦„</label>
                    <input type="text" id="single-npc" class="form-input" placeholder="NPC ì´ë¦„">
                </div>
                <div class="form-group">
                    <label class="form-label">ìƒì„¸ ë‚´ìš©</label>
                    <textarea id="single-item" class="form-input" style="height:80px;"
                        placeholder="ìƒì„¸ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”..."></textarea>

                    <div id="exchange-edit-group" style="display:none;">
                        <div style="display:flex; align-items:center; gap:5px; margin-bottom:5px;">
                            <input type="text" id="ex-give-item" class="form-input" placeholder="ì¤„ ë¬¼ê±´">
                            <input type="number" id="ex-give-qty" class="form-input" style="width:60px;" placeholder="ê°œ"
                                min="0">
                        </div>
                        <div style="display:flex; align-items:center; gap:5px;">
                            <input type="text" id="ex-get-item" class="form-input" placeholder="ë°›ì„ ë¬¼ê±´">
                            <input type="number" id="ex-get-qty" class="form-input" style="width:60px;" placeholder="ê°œ"
                                min="0">
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" onclick="closeSingleModal()">ì·¨ì†Œ</button>
                <div style="flex:1;"></div>
                <button class="btn-submit" style="background-color:#ef4444; margin-right:10px;"
                    onclick="deleteCurrentItem()">ì‚­ì œ</button>
                <button class="btn-submit" onclick="saveSingleItem()">ì €ì¥í•˜ê¸°</button>
            </div>
        </div>
    </div>

    <!-- í™•ì¸ ëª¨ë‹¬ (Custom Confirm) -->
    <div id="confirm-modal" class="modal-overlay" style="z-index: 2200;">
        <div class="modal" style="max-width:300px;">
            <div class="modal-body" style="text-align:center; padding:30px 20px;">
                <p id="confirm-msg" style="font-weight:bold;"></p>
            </div>
            <div class="modal-footer" style="justify-content: center; gap:10px; padding-bottom: 20px;">
                <button class="btn-cancel" onclick="closeConfirmModal()"
                    style="padding: 8px 16px; border: 1px solid #d1d5db; background: white; border-radius: 6px; cursor: pointer;">ì·¨ì†Œ</button>
                <button class="btn-submit" id="confirm-ok-btn"
                    style="background-color:#ef4444; color:white; padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer;">í™•ì¸</button>
            </div>
        </div>
    </div>

    <!-- í†µí•© ê´€ë¦¬ ëª¨ë‹¬ (ì£¼ê°„êµ¬ë§¤/êµí™˜/ì¼ì¼êµí™˜) -->
    <div id="manager-modal" class="modal-overlay">
        <div class="modal" style="max-width:400px;">
            <div class="modal-header">
                <div class="modal-title" id="manager-modal-title">í•­ëª© ê´€ë¦¬</div>
                <button class="add-menu-btn" style="margin-left:auto; margin-right:8px;"
                    onclick="openSingleModal(document.getElementById('manage-type').value)">â• ì¶”ê°€</button>
                <button class="close-btn" onclick="closeManagerModal()">Ã—</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="manage-type">
                <div id="manage-list" class="manage-list"></div>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" onclick="closeManagerModal()">ë‹«ê¸°</button>
            </div>
        </div>
    </div>

    <!-- ìºë¦­í„° ê´€ë¦¬ ëª¨ë‹¬ -->
    <div id="char-modal" class="modal-overlay">
        <div class="modal" style="max-width:400px;">
            <div class="modal-header">
                <div class="modal-title">ğŸ‘¥ ìºë¦­í„° ê´€ë¦¬</div>
                <button class="close-btn"
                    onclick="document.getElementById('char-modal').classList.remove('open')">Ã—</button>
            </div>
            <div class="modal-body">
                <div id="char-list" class="manage-list"></div>
                <div style="display:flex; gap:5px; margin-top:10px; border-top:1px solid #eee; padding-top:10px;">
                    <input type="text" id="new-char-name" class="form-input" placeholder="ìƒˆ ìºë¦­í„° ì´ë¦„">
                    <button class="btn-submit" style="width:80px;" onclick="addChar()">ì¶”ê°€</button>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel"
                    onclick="document.getElementById('char-modal').classList.remove('open')">ë‹«ê¸°</button>
            </div>
        </div>
    </div>

    <!-- ë©”ë‰´ ê´€ë¦¬ ì „ìš© ëª¨ë‹¬ -->
    <div id="menu-manager-modal" class="modal-overlay">
        <div class="modal" style="max-width:400px;">
            <div class="modal-header">
                <div class="modal-title">ğŸ“‹ ë©”ë‰´ ê´€ë¦¬</div>
                <button class="add-menu-btn" style="margin-left:auto; margin-right:8px;" onclick="openModal()">â•
                    ì¶”ê°€</button>
                <button class="close-btn" onclick="closeMenuManager()">Ã—</button>
            </div>
            <div class="modal-body">
                <div id="menu-manage-list" class="manage-list"></div>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" onclick="closeMenuManager()">ë‹«ê¸°</button>
            </div>
        </div>
    </div>

    <script>
        // const defaultNicknames = { 'main': 'ë§ë‘ë§ë‘ì»¤í”¼', 'sub1': 'ìƒˆì½¤ë‹¬ì½¤ìœ ê¸°ë†ì»¤í”¼', 'sub2': 'MNe', 'sub3': 'í”„ë¦°ìŠ¤', 'sub4': 'ë³„ì˜ë°”ë‹¤' };
        let charKeys = []; // ë™ì  ë¡œë“œë¨

        const initialData = {
            version: 9,
            menus: [
                { id: 'apple_cake', label: 'ì‚¬ê³¼ì¼€ì´í¬ (ì¼ì¼)', npc: 'ì œì´ë¯¸', village: 'ë˜ë°”íŠ¼', cycle: 'daily', giveQty: 7, reward: 'ìƒê¸‰ ì˜·ê°+', rewardQty: '28' },
                { id: 'steak', label: 'ìŠ¤í…Œì´í¬ (ì¼ì¼)', npc: 'ì œë¡¬', village: 'ë˜ë°”íŠ¼', cycle: 'daily', giveQty: 7, reward: 'ìƒê¸‰ ì‹¤í¬', rewardQty: '28' },
                { id: 'veggie', label: 'ì•¼ì±„ë³¶ìŒ (ì¼ì¼)', npc: 'ì•¨ë¹ˆ', village: 'ë‘ê°ˆë“œì•„ì¼', cycle: 'daily', giveQty: 70, reward: 'ìƒê¸‰ ëª©ì¬', rewardQty: '56x5' },
                { id: 'pumpkin', label: 'í˜¸ë°•ìŠ¤í”„ (ì£¼ê°„)', npc: 'ë¸ë Œ', village: 'ì´ë©˜ë§ˆí•˜', cycle: 'weekly', giveQty: 5, reward: 'ìµœìƒê¸‰ê°€ì£½+, ìµœìƒê¸‰ëª©ì¬+,ë°ì½”ë ˆì–´3', rewardQty: '' },
                { id: 'curry', label: 'ì¹´ë ˆë¼ì´ìŠ¤ (ì£¼ê°„)', npc: 'ì˜¤ìŠ¬ë¼', village: 'ì´ë©˜ë§ˆí•˜', cycle: 'weekly', giveQty: 4, reward: 'ìš´ì² ê´´', rewardQty: '2' },
                { id: 'fish', label: 'ë†ì–´ë§¤ìš´íƒ• (ì£¼ê°„)', npc: 'ì•„ì´ë°ë¥¸', village: 'ë°˜í˜¸ë¥´', cycle: 'weekly', giveQty: 5, reward: 'ì€í•©ê¸ˆê´´', rewardQty: '10' },
                { id: 'green_cake', label: 'ë…¹ì°¨ì¼€ì´í¬ (ì£¼ê°„)', npc: 'ë¸ë Œ', village: 'ì´ë©˜ë§ˆí•˜', cycle: 'weekly', giveQty: 10, reward: 'ë°ì½” ì—˜ë¦¬íŠ¸', rewardQty: '15' }
            ],
            characters: [
                { id: 'main', name: 'ìºë¦­í„°1' },
                { id: 'sub1', name: 'ìºë¦­í„°2' },
                { id: 'sub2', name: 'ìºë¦­í„°3' }
            ],
            cooking: [
                {
                    village: 'ìš”ë¦¬ ëª©ë¡', items: [
                        { id: 'c_1768934104620', npc: 'ìŠ¤í…Œì´í¬ (7ê°œ)', item: 'ê³ ê¸° 70, ìƒí¬ë¦¼ 14, ë§ˆëŠ˜ 14, í›„ì¶” 21', tag: 'steak', defaultRole: ['each'] },
                        { id: 'c_1768934182600', npc: 'ì•¼ì±„ë³¶ìŒ (70ê°œ)', item: 'ê°ì 560, ì–‘íŒŒ 210, ì–‘ë°°ì¶” 420, í—ˆë¸Œ 140', tag: 'veggie', defaultRole: ['each'] },
                        { id: 'c_1768934220650', npc: 'í˜¸ë°•ìŠ¤í”„ (5ê°œ)', item: 'í˜¸ë°• 50, ê°ì 30, ì–‘íŒŒ 30, ìƒê°• 10, ìƒí¬ë¦¼ 25', tag: 'pumpkin', defaultRole: ['each'] },
                        { id: 'c_1768934251505', npc: 'ì¹´ë ˆë¼ì´ìŠ¤ (4ê°œ)', item: 'ë°¥ 12, ê³ ê¸° 40, ë‹¹ê·¼ 12, ê°ì 32, ì¹´ë ˆê°€ë£¨ 8', tag: 'curry', defaultRole: ['each'] },
                        { id: 'c_1768934266242', npc: 'ë†ì–´ë§¤ìš´íƒ• (5ê°œ)', item: 'ë†ì–´ 30, ë¬´ 20, ê³ ì¶§ê°€ë£¨ 20, í›„ì¶” 10, ì–‘íŒŒ 30', tag: 'fish', defaultRole: ['each'] },
                        { id: 'c_1768934319973', npc: 'ë…¹ì°¨ì¼€ì´í¬ (10ê°œ)', item: 'ì°»ì 100, ë”¸ê¸° 60, ìƒí¬ë¦¼ 60, ë°€ê°€ë£¨ 40, ì„¤íƒ• 60', tag: 'green_cake', defaultRole: ['each'] },
                        { id: 'c_1768934328313', npc: 'ì‚¬ê³¼ì¼€ì´í¬ (7ê°œ)', item: 'ì‚¬ê³¼ 84, ì„¤íƒ• 63, ë°€ê°€ë£¨ 28, ìƒí¬ë¦¼ 14', tag: 'apple_cake', defaultRole: ['each'] }
                    ]
                }
            ],
            shopping: [
                { village: 'ì´ë©˜ë§ˆí•˜', items: [{ npc: 'í”„ë ˆì´ì €', item: 'ìƒí¬ë¦¼, ì„¤íƒ•, ë°€ê°€ë£¨, ì¹´ë ˆê°€ë£¨, í›„ì¶”' }, { npc: 'ê³ ë“ ', item: 'ê³ ê¸°, ìƒê°•, ë‹¹ê·¼, ë§ˆëŠ˜' }] },
                { village: 'ë°˜í˜¸ë¥´', items: [{ npc: 'ì œë‹ˆí¼', item: 'ê³ ê¸°(ë³´ì¶©ìš©)' }] },
                { village: 'ë˜ë°”íŠ¼', items: [{ npc: 'ë§ˆëˆ„ìŠ¤', item: 'ë²„ì„¯ì§„ì•¡ 3ì¢…' }, { npc: 'ê¸€ë¦¬ë‹ˆìŠ¤', item: 'ì‚¬ê³¼, í›„ì¶”(ë³´ì¶©)' }] },
                { village: 'í‹°ë¥´ì½”ë„¤ì¼', items: [{ npc: 'ë§ì½¤', item: 'ìƒê°€ì£½, ì˜·ê°' }, { npc: 'ì¼€ì´í‹´', item: 'ì‚¬ê³¼, ì„¤íƒ•' }] }
            ],
            weekly: [
                { village: 'ì´ë©˜ë§ˆí•˜', items: [{ npc: 'ê³ ë“ ', item: 'ìŒ€ 150ê°œ â†’ ë°€ê°€ë£¨ 50ê°œ' }, { npc: 'ë¸ë Œ', item: 'ë…¹ì°¨ì¼€ì´í¬ 2ê°œ â†’ ë°ì½” ì—˜ë¦¬íŠ¸ 3ê°œ' }, { npc: 'ë¸ë Œ', item: 'í˜¸ë°•ìŠ¤í”„ 5ê°œ â†’ ê°€ì£½+/ëª©ì¬+/ë°ì½” ê°œ' }, { npc: 'ì˜¤ìŠ¬ë¼', item: 'ì¹´ë ˆë¼ì´ìŠ¤ 4ê°œ â†’ ìš´ì² ê´´ 2ê°œ' }] },
                { village: 'ë‘ê°ˆë“œì•„ì¼', items: [] },
                { village: 'ë°˜í˜¸ë¥´', items: [{ npc: 'ì•„ì´ë°ë¥¸', item: 'ë†ì–´ë§¤ìš´íƒ• 1ê°œ â†’ ì€í•©ê¸ˆê´´ 10ê°œ' }] }
            ],
            daily: [
                { village: 'ë˜ë°”íŠ¼', items: [{ npc: 'ì œë¡¬', item: 'í¬ë¦¼ì†ŒìŠ¤ ìŠ¤í…Œì´í¬ 1ê°œ â†’ ìƒê¸‰ì‹¤í¬ 4ê°œ' }, { npc: 'ì œì´ë¯¸', item: 'ì‚¬ê³¼ì¼€ì´í¬ 1ê°œ â†’ ìƒê¸‰ì˜·ê°+ 4ê°œ' }] },
                { village: 'ë‘ê°ˆë“œì•„ì¼', items: [{ npc: 'ì•¨ë¹ˆ', item: 'ì•¼ì±„ë³¶ìŒ 2ê°œ â†’ ìƒê¸‰ëª©ì¬ 8ê°œ' }] }
            ],
            customPrep: [
                { id: 'steak_ê³ ê¸°_1768934104620', type: 'base', owner: 'main', title: 'ğŸ¥© ê³ ê¸° 70ê°œ êµ¬ë§¤', desc: 'ì¹´ë ˆë¼ì´ìŠ¤ìš©', color: '#9c2121', tag: 'steak', village: 'ë°˜í˜¸ë¥´', npc: 'ì œë‹ˆí¼' },
                { id: 'steak_ìƒí¬ë¦¼_1768934104620', type: 'base', owner: 'main', title: 'ğŸ¥› ìƒí¬ë¦¼ 14ê°œ êµ¬ë§¤', desc: 'ìŠ¤í…Œì´í¬ìš©', color: '#6b7280', tag: 'steak', village: 'ì´ë©˜ë§ˆí•˜', npc: 'í”„ë ˆì´ì €' },
                { id: 'steak_ë§ˆëŠ˜_1768934104620', type: 'base', owner: 'main', title: 'ğŸ§„ ë§ˆëŠ˜ 14ê°œ êµ¬ë§¤', desc: 'ìŠ¤í…Œì´í¬ìš©', color: '#af853c', tag: 'steak', village: 'ì´ë©˜ë§ˆí•˜', npc: 'ê³ ë“ ' },
                { id: 'steak_í›„ì¶”_1768934104620', type: 'base', owner: 'main', title: 'ğŸ§‚ í›„ì¶” 21ê°œ êµ¬ë§¤', desc: 'ìŠ¤í…Œì´í¬ìš©', color: '#6b7280', tag: 'steak', village: 'ë˜ë°”íŠ¼', npc: 'ê¸€ë¦¬ë‹ˆìŠ¤' },
                { id: 'veggie_ê°ì_1768934182600', type: 'base', owner: 'main', title: 'ğŸ¥” ê°ì 560ê°œ ì±„ì§‘', desc: 'ì¹´ë ˆë¼ì´ìŠ¤ìš©', color: '#b45309', tag: 'veggie', village: '', npc: '' },
                { id: 'veggie_ì–‘íŒŒ_1768934182600', type: 'base', owner: 'main', title: 'ğŸ§… ì–‘íŒŒ 210ê°œ ì±„ì§‘', desc: 'ì•¼ì±„ë³¶ìŒìš©', color: '#ba8d40', tag: 'veggie', village: '', npc: '' },
                { id: 'veggie_ì–‘ë°°ì¶”_1768934182600', type: 'base', owner: 'main', title: 'ğŸ¥¬ ì–‘ë°°ì¶” 420ê°œ ì±„ì§‘', desc: 'ì•¼ì±„ë³¶ìŒìš©', color: '#24c660', tag: 'veggie', village: '', npc: '' },
                { id: 'veggie_í—ˆë¸Œ_1768934182600', type: 'base', owner: 'main', title: 'ğŸŒ¿ í—ˆë¸Œ 140ê°œ ì±„ì§‘', desc: 'ì•¼ì±„ë³¶ìŒìš©', color: '#15803d', tag: 'veggie', village: '', npc: '' },
                { id: 'pumpkin_í˜¸ë°•_1768934220650', type: 'base', owner: 'main', title: 'ğŸƒ í˜¸ë°• 50ê°œ ì±„ì§‘', desc: 'í˜¸ë°•ìŠ¤í”„ìš©', color: '#f97316', tag: 'pumpkin', village: '', npc: '' },
                { id: 'pumpkin_ê°ì_1768934220650', type: 'base', owner: 'main', title: 'ğŸ¥” ê°ì 30ê°œ ì±„ì§‘', desc: 'ì¹´ë ˆë¼ì´ìŠ¤ìš©', color: '#b45309', tag: 'pumpkin', village: '', npc: '' },
                { id: 'pumpkin_ì–‘íŒŒ_1768934220650', type: 'base', owner: 'main', title: 'ğŸ§… ì–‘íŒŒ 30ê°œ ì±„ì§‘', desc: 'ì•¼ì±„ë³¶ìŒìš©', color: '#ba8d40', tag: 'pumpkin', village: '', npc: '' },
                { id: 'pumpkin_ìƒê°•_1768934220650', type: 'base', owner: 'main', title: 'ğŸ«š ìƒê°• 10ê°œ êµ¬ë§¤', desc: 'í˜¸ë°•ìŠ¤í”„ìš©', color: '#b88d42', tag: 'pumpkin', village: 'ì´ë©˜ë§ˆí•˜', npc: 'ê³ ë“ ' },
                { id: 'pumpkin_ìƒí¬ë¦¼_1768934220650', type: 'base', owner: 'main', title: 'ğŸ¥› ìƒí¬ë¦¼ 25ê°œ êµ¬ë§¤', desc: 'ìŠ¤í…Œì´í¬ìš©', color: '#6b7280', tag: 'pumpkin', village: 'ì´ë©˜ë§ˆí•˜', npc: 'í”„ë ˆì´ì €' },
                { id: 'curry_ë°¥_1768934251505', type: 'base', owner: 'main', title: 'ğŸš ë°¥ 12ê°œ ì œì‘', desc: 'ì¹´ë ˆë¼ì´ìŠ¤ìš©', color: '#6b7280', tag: 'curry', village: '', npc: '' },
                { id: 'curry_ê³ ê¸°_1768934251505', type: 'base', owner: 'main', title: 'ğŸ¥© ê³ ê¸° 40ê°œ êµ¬ë§¤', desc: 'ì¹´ë ˆë¼ì´ìŠ¤ìš©', color: '#9c2121', tag: 'curry', village: 'ë°˜í˜¸ë¥´', npc: 'ì œë‹ˆí¼' },
                { id: 'curry_ë‹¹ê·¼_1768934251505', type: 'base', owner: 'main', title: 'ğŸ¥• ë‹¹ê·¼ 12ê°œ êµ¬ë§¤', desc: 'ì¹´ë ˆë¼ì´ìŠ¤ìš©', color: '#ef4444', tag: 'curry', village: 'ì´ë©˜ë§ˆí•˜', npc: 'ê³ ë“ ' },
                { id: 'curry_ê°ì_1768934251505', type: 'base', owner: 'main', title: 'ğŸ¥” ê°ì 32ê°œ ì±„ì§‘', desc: 'ì¹´ë ˆë¼ì´ìŠ¤ìš©', color: '#b45309', tag: 'curry', village: '', npc: '' },
                { id: 'curry_ì¹´ë ˆê°€ë£¨_1768934251505', type: 'base', owner: 'main', title: 'ğŸ“¦ ì¹´ë ˆê°€ë£¨ 8ê°œ êµ¬ë§¤', desc: 'ì¹´ë ˆë¼ì´ìŠ¤ìš©', color: '#f59e0b', tag: 'curry', village: 'ì´ë©˜ë§ˆí•˜', npc: 'í”„ë ˆì´ì €' },
                { id: 'fish_ë†ì–´_1768934266242', type: 'base', owner: 'main', title: 'ğŸ£ ë†ì–´ 30ê°œ ë‚šì‹œ', desc: 'ë†ì–´ë§¤ìš´íƒ•ìš©', color: '#3b82f6', tag: 'fish', village: '', npc: '' },
                { id: 'fish_ë¬´_1768934266242', type: 'base', owner: 'main', title: 'ğŸ¥¦ ë¬´ 20ê°œ êµ¬ë§¤', desc: 'ë†ì–´ë§¤ìš´íƒ•ìš©', color: '#8dceb5', tag: 'fish', village: 'ì´ë©˜ë§ˆí•˜', npc: 'ê³ ë“ ' },
                { id: 'fish_ê³ ì¶§ê°€ë£¨_1768934266242', type: 'base', owner: 'main', title: 'ğŸŒ¶ï¸ ê³ ì¶§ê°€ë£¨ 20ê°œ êµ¬ë§¤', desc: 'ë†ì–´ë§¤ìš´íƒ•ìš©', color: '#ef4444', tag: 'fish', village: 'ì´ë©˜ë§ˆí•˜', npc: 'í”„ë ˆì´ì €' },
                { id: 'fish_í›„ì¶”_1768934266242', type: 'base', owner: 'main', title: 'ğŸ§‚ í›„ì¶” 10ê°œ êµ¬ë§¤', desc: 'ìŠ¤í…Œì´í¬ìš©', color: '#6b7280', tag: 'fish', village: 'ë˜ë°”íŠ¼', npc: 'ê¸€ë¦¬ë‹ˆìŠ¤' },
                { id: 'fish_ì–‘íŒŒ_1768934266242', type: 'base', owner: 'main', title: 'ğŸ§… ì–‘íŒŒ 30ê°œ ì±„ì§‘', desc: 'ì•¼ì±„ë³¶ìŒìš©', color: '#ba8d40', tag: 'fish', village: 'ì´ë©˜ë§ˆí•˜', npc: '' },
                { id: 'green_cake_ì°»ì_1768934319973', type: 'base', owner: 'main', title: 'ğŸŒ¿ ì°»ì 100ê°œ ì±„ì§‘', desc: 'ë…¹ì°¨ì¼€ì´í¬ìš©', color: '#15803d', tag: 'green_cake', village: '', npc: '' },
                { id: 'green_cake_ë”¸ê¸°_1768934319973', type: 'base', owner: 'main', title: 'ğŸ“ ë”¸ê¸° 60ê°œ êµ¬ë§¤', desc: 'ë…¹ì°¨ì¼€ì´í¬ìš©', color: '#ef4444', tag: 'green_cake', village: 'ì½œí—¨', npc: 'ì½”ë„ˆ' },
                { id: 'green_cake_ìƒí¬ë¦¼_1768934319973', type: 'base', owner: 'main', title: 'ğŸ¥› ìƒí¬ë¦¼ 60ê°œ êµ¬ë§¤', desc: 'ìŠ¤í…Œì´í¬ìš©', color: '#6b7280', tag: 'green_cake', village: 'ì´ë©˜ë§ˆí•˜', npc: 'í”„ë ˆì´ì €' },
                { id: 'green_cake_ë°€ê°€ë£¨_1768934319973', type: 'base', owner: 'main', title: 'ğŸ“¦ ë°€ê°€ë£¨ 40ê°œ êµ¬ë§¤', desc: 'ë…¹ì°¨ì¼€ì´í¬ìš©', color: '#6b7280', tag: 'green_cake', village: 'ì´ë©˜ë§ˆí•˜', npc: 'í”„ë ˆì´ì €' },
                { id: 'green_cake_ì„¤íƒ•_1768934319973', type: 'base', owner: 'main', title: 'ğŸ§‚ ì„¤íƒ• 60ê°œ êµ¬ë§¤', desc: 'ì‚¬ê³¼ì¼€ì´í¬ìš©', color: '#6b7280', tag: 'green_cake', village: 'í‹°ë¥´ì½”ë„¤ì¼', npc: 'ì¼€ì´í‹´' },
                { id: 'apple_cake_ì‚¬ê³¼_1768934328313', type: 'base', owner: 'main', title: 'ğŸ ì‚¬ê³¼ 84ê°œ êµ¬ë§¤', desc: 'ì‚¬ê³¼ì¼€ì´í¬ìš©', color: '#ef4444', tag: 'apple_cake', village: 'í‹°ë¥´ì½”ë„¤ì¼', npc: 'ì¼€ì´í‹´' },
                { id: 'apple_cake_ì„¤íƒ•_1768934328313', type: 'base', owner: 'main', title: 'ğŸ§‚ ì„¤íƒ• 63ê°œ êµ¬ë§¤', desc: 'ì‚¬ê³¼ì¼€ì´í¬ìš©', color: '#6b7280', tag: 'apple_cake', village: 'í‹°ë¥´ì½”ë„¤ì¼', npc: 'ì¼€ì´í‹´' },
                { id: 'apple_cake_ë°€ê°€ë£¨_1768934328313', type: 'base', owner: 'main', title: 'ğŸ“¦ ë°€ê°€ë£¨ 28ê°œ êµ¬ë§¤', desc: 'ë…¹ì°¨ì¼€ì´í¬ìš©', color: '#6b7280', tag: 'apple_cake', village: 'ì´ë©˜ë§ˆí•˜', npc: 'í”„ë ˆì´ì €' },
                { id: 'apple_cake_ìƒí¬ë¦¼_1768934328313', type: 'base', owner: 'main', title: 'ğŸ¥› ìƒí¬ë¦¼ 14ê°œ êµ¬ë§¤', desc: 'ìŠ¤í…Œì´í¬ìš©', color: '#6b7280', tag: 'apple_cake', village: 'ì´ë©˜ë§ˆí•˜', npc: 'í”„ë ˆì´ì €' }
            ],
            commonPrep: [
                { id: 'common_quest', title: 'ğŸ“œ ì±„ì§‘ ì„ë¬´ êµ¬ë§¤', desc: 'ìƒí™œë ¥ ì—…ì—…! (ìƒì )', color: '#b45309' }
            ]
        };

        const prepItemsDef = [
            { id: 'pepper', type: 'base', title: 'ğŸ§‚ í›„ì¶” {qty}ê°œ êµ¬ë§¤', desc: 'ë§¤ìš´íƒ•/ìŠ¤í…Œì´í¬ìš©', color: '#b91c1c', icon: 'ğŸ§‚', baseName: 'í›„ì¶”' },
            { id: 'chili', type: 'base', title: 'ğŸŒ¶ï¸ ê³ ì¶§ê°€ë£¨ {qty}ê°œ êµ¬ë§¤', desc: 'ë§¤ìš´íƒ•ìš© (ê¸€ë¦¬ë‹ˆìŠ¤)', color: '#b91c1c', icon: 'ğŸŒ¶ï¸', baseName: 'ê³ ì¶§ê°€ë£¨' },
            { id: 'apple', type: 'base', title: 'ğŸ ì‚¬ê³¼ {qty}ê°œ ì±„ì§‘', desc: 'ì‚¬ê³¼ì¼€ìµìš©', color: '#ef4444', icon: 'ğŸ', baseName: 'ì‚¬ê³¼' },
            { id: 'meat', type: 'base', title: 'ğŸ– ê³ ê¸° {qty}ê°œ êµ¬ë§¤', desc: 'ìŠ¤í…Œì´í¬/ì¹´ë ˆ', color: '#b91c1c', icon: 'ğŸ–', baseName: 'ê³ ê¸°' },
            { id: 'rice', type: 'base', title: 'ğŸš ë°¥ {qty}ê°œ ì œì‘', desc: 'ìŒ€ ì±„ì§‘ ë³‘í–‰ (ì¹´ë ˆìš©)', color: '#4f46e5', icon: 'ğŸš', baseName: 'ë°¥' },
            { id: 'potato', type: 'base', title: 'ğŸ¥” ê°ì {qty}ê°œ ì±„ì§‘', desc: 'ì§ì ‘ ì±„ì§‘ í•­ëª©', color: '#374151', icon: 'ğŸ¥”', baseName: 'ê°ì' },
            { id: 'sugar', type: 'base', title: 'ğŸ§‚ ì„¤íƒ• {qty}ê°œ êµ¬ë§¤', desc: 'ì‚¬ê³¼ì¼€ìµ/ë…¹ì°¨ì¼€ìµ', color: '#374151', icon: 'ğŸ§‚', baseName: 'ì„¤íƒ•' },
            { id: 'flour', type: 'base', title: 'ğŸ“¦ ë°€ê°€ë£¨ {qty}ê°œ êµ¬ë§¤', desc: 'ì‚¬ê³¼ì¼€ìµ/ë…¹ì°¨ì¼€ìµ', color: '#374151', icon: 'ğŸ“¦', baseName: 'ë°€ê°€ë£¨' },
            { id: 'cream', type: 'base', title: 'ğŸ¥› ìƒí¬ë¦¼ {qty}ê°œ êµ¬ë§¤', desc: 'ì‚¬ê³¼ì¼€ìµ/ìŠ¤í…Œì´í¬/í˜¸ë°•ìŠ¤í”„/ë…¹ì°¨ì¼€ìµ', color: '#374151', icon: 'ğŸ¥›', baseName: 'ìƒí¬ë¦¼' },
            { id: 'garlic', type: 'base', title: 'ğŸ§„ ë§ˆëŠ˜ {qty}ê°œ êµ¬ë§¤', desc: 'ìŠ¤í…Œì´í¬ìš©', color: '#374151', icon: 'ğŸ§„', baseName: 'ë§ˆëŠ˜' },
            { id: 'onion', type: 'base', title: 'ğŸ§… ì–‘íŒŒ {qty}ê°œ ì±„ì§‘', desc: 'ì•¼ì±„ë³¶ìŒ/í˜¸ë°•ìŠ¤í”„/ë†ì–´ë§¤ìš´íƒ•', color: '#374151', icon: 'ğŸ§…', baseName: 'ì–‘íŒŒ' },
            { id: 'cabbage', type: 'base', title: 'ğŸ¥¬ ì–‘ë°°ì¶” {qty}ê°œ êµ¬ë§¤', desc: 'ì•¼ì±„ë³¶ìŒìš©', color: '#374151', icon: 'ğŸ¥¬', baseName: 'ì–‘ë°°ì¶”' },
            { id: 'herb', type: 'base', title: 'ğŸŒ¿ í—ˆë¸Œ {qty}ê°œ ì±„ì§‘', desc: 'ì•¼ì±„ë³¶ìŒìš©', color: '#15803d', icon: 'ğŸŒ¿', baseName: 'í—ˆë¸Œ' },
            { id: 'pumpkin_base', type: 'base', title: 'ğŸƒ í˜¸ë°• {qty}ê°œ ì±„ì§‘', desc: 'í˜¸ë°•ìŠ¤í”„ìš©', color: '#f59e0b', icon: 'ğŸƒ', baseName: 'í˜¸ë°•' },
            { id: 'ginger', type: 'base', title: 'ğŸ  ìƒê°• {qty}ê°œ êµ¬ë§¤', desc: 'í˜¸ë°•ìŠ¤í”„ìš©', color: '#374151', icon: 'ğŸ ', baseName: 'ìƒê°•' },
            { id: 'carrot', type: 'base', title: 'ğŸ¥• ë‹¹ê·¼ {qty}ê°œ êµ¬ë§¤', desc: 'ì¹´ë ˆìš©', color: '#ef4444', icon: 'ğŸ¥•', baseName: 'ë‹¹ê·¼' },
            { id: 'curry_powder', type: 'base', title: 'ğŸ› ì¹´ë ˆê°€ë£¨ {qty}ê°œ êµ¬ë§¤', desc: 'ì¹´ë ˆìš©', color: '#f59e0b', icon: 'ğŸ›', baseName: 'ì¹´ë ˆê°€ë£¨' },
            { id: 'bass', type: 'base', title: 'ğŸŸ ë†ì–´ {qty}ê°œ ë‚šì‹œ', desc: 'ë§¤ìš´íƒ•ìš©', color: '#4f46e5', icon: 'ğŸŸ', baseName: 'ë†ì–´' },
            { id: 'radish', type: 'base', title: 'ğŸ¥¬ ë¬´ {qty}ê°œ êµ¬ë§¤', desc: 'ë§¤ìš´íƒ•ìš©', color: '#374151', icon: 'ğŸ¥¬', baseName: 'ë¬´' },
            { id: 'tea_leaf', type: 'base', title: 'ğŸƒ ì°»ì {qty}ê°œ ì±„ì§‘', desc: 'ë…¹ì°¨ì¼€ìµìš©', color: '#15803d', icon: 'ğŸƒ', baseName: 'ì°»ì' },
            { id: 'strawberry', type: 'base', title: 'ğŸ“ ë”¸ê¸° {qty}ê°œ êµ¬ë§¤', desc: 'ë…¹ì°¨ì¼€ìµìš©', color: '#ef4444', icon: 'ğŸ“', baseName: 'ë”¸ê¸°' }
        ];

        let appData = {};

        function init() {
            loadData();

            // charKeys ì„¸íŒ…
            charKeys = appData.characters.map(c => c.id);

            // migration: rice/potato description from localstorage if any
            prepItemsDef.forEach(item => {
                const savedTitle = localStorage.getItem(`prep_title_${item.id}`);
                const savedDesc = localStorage.getItem(`prep_desc_${item.id}`);
                const savedIcon = localStorage.getItem(`prep_icon_${item.id}`);
                if (savedTitle) item.title = savedTitle;
                if (savedDesc) item.desc = savedDesc;
                if (savedIcon) item.icon = savedIcon;
            });
            renderMenuToggles();
            renderHeaders();
            refreshAll();

            // ë‹‰ë„¤ì„ ë¡œë“œ ë¶ˆí•„ìš” - appData.characters ì‚¬ìš©
            document.getElementById('tab-memo').value = localStorage.getItem('mabi_tab_memo') || '';
        }

        function loadData() {
            const stored = localStorage.getItem('mabi_data_v9');
            if (stored) {
                const parsed = JSON.parse(stored);
                if (!parsed.version || parsed.version < initialData.version) {
                    appData = JSON.parse(JSON.stringify(initialData));
                    saveData();
                } else {
                    appData = parsed;
                    if (!appData.commonPrep) appData.commonPrep = [];
                    if (!appData.characters) appData.characters = JSON.parse(JSON.stringify(initialData.characters));

                    // ê¸°ì¡´ ë°ì´í„° ëŒ€ê·œëª¨ í˜¸í™˜ íŒ¨ì¹˜ (ë²„ì „9 ê¸°ì¤€)
                    if (appData.shopping) {
                        appData.shopping.forEach(group => {
                            if (group.village === 'ì´ë©˜ ë§ˆí•˜') group.village = 'ì´ë©˜ë§ˆí•˜';
                            if (group.village === 'í‹°ë¥´ ì½”ë„¤ì¼') group.village = 'í‹°ë¥´ì½”ë„¤ì¼';
                            group.items.forEach(si => {
                                si.item = si.item.replace(/\(\d+.*?\)/g, '').replace(/,\s*,/g, ',').replace(/,\s*$/g, '');
                            });
                        });
                        if (appData.weekly) appData.weekly.forEach(g => {
                            if (g.village === 'ì´ë©˜ ë§ˆí•˜') g.village = 'ì´ë©˜ë§ˆí•˜';
                            if (g.village === 'í‹°ë¥´ ì½”ë„¤ì¼') g.village = 'í‹°ë¥´ì½”ë„¤ì¼';
                        });
                        if (appData.daily) appData.daily.forEach(g => {
                            if (g.village === 'ì´ë©˜ ë§ˆí•˜') g.village = 'ì´ë©˜ë§ˆí•˜';
                            if (g.village === 'í‹°ë¥´ ì½”ë„¤ì¼') g.village = 'í‹°ë¥´ì½”ë„¤ì¼';
                        });
                    }
                }
            } else {
                appData = JSON.parse(JSON.stringify(initialData));
                saveData();
            }
        }

        function saveData() {
            localStorage.setItem('mabi_data_v9', JSON.stringify(appData));
        }

        // --- ë Œë”ë§ ---
        function refreshAll() {
            renderPrepGrid();
            renderCommonPrep();

            // ìš”ë¦¬ ë°ì´í„° ë¶„ë¦¬ (Daily / Weekly)
            const dailyCook = [];
            const weeklyCook = [];

            appData.cooking.forEach(group => {
                group.items.forEach(item => {
                    const menu = appData.menus.find(m => m.id === item.tag);
                    const label = menu ? menu.label : "";
                    // ë°ì¼ë¦¬ íŒë³„ ë¡œì§ (ê¸°ì¡´ í† ê¸€ ë¡œì§ê³¼ ë™ì¼)
                    if (label.includes('(ì¼ì¼)') || item.tag === 'apple_cake' || item.tag === 'steak' || item.tag === 'veggie') {
                        dailyCook.push(item);
                    } else {
                        weeklyCook.push(item);
                    }
                });
            });

            const splitCooking = [];
            if (dailyCook.length > 0) splitCooking.push({ village: 'â˜€ï¸ DAILY', items: dailyCook });
            if (weeklyCook.length > 0) splitCooking.push({ village: 'ğŸ—“ï¸ WEEKLY', items: weeklyCook });

            renderBody('body-cooking', splitCooking, 'cook');
            renderBody('body-shopping', appData.shopping, 'shop');
            renderBody('body-weekly', appData.weekly, 'week');
            renderBody('body-daily', appData.daily, 'day');
        }

        function renderMenuToggles() {
            const dContainer = document.getElementById('menu-toggles-daily');
            const wContainer = document.getElementById('menu-toggles-weekly');
            let dHtml = '', wHtml = '';

            appData.menus.forEach(tag => {
                const isActive = isTagActive(tag.id);
                const html = `
                <div class="toggle-item ${isActive ? 'active' : ''}">
                    <div class="toggle-switch" onclick="toggleMenu('${tag.id}', this.parentElement)"><div class="toggle-dot"></div></div>
                    <span class="toggle-label" onclick="toggleMenu('${tag.id}', this.parentElement)">${tag.label.replace(' (ì¼ì¼)', '').replace(' (ì£¼ê°„)', '')}</span>
                </div>
            `;
                if (tag.label.includes('(ì¼ì¼)') || tag.id === 'apple_cake' || tag.id === 'steak' || tag.id === 'veggie') {
                    dHtml += html;
                } else {
                    wHtml += html;
                }
            });
            dContainer.innerHTML = dHtml;
            wContainer.innerHTML = wHtml;
        }

        function isTagActive(tagId) {
            const state = localStorage.getItem(`menu_${tagId}`);
            return state === null ? true : (state === 'true');
        }

        function toggleMenu(id, el) {
            const newState = !el.classList.contains('active');
            if (newState) el.classList.add('active'); else el.classList.remove('active');
            localStorage.setItem(`menu_${id}`, newState);
            refreshAll();
        }

        function toggleCharSection(header) {
            header.classList.toggle('collapsed');
            const nick = header.innerText.split(' ')[0]; // ë‹¨ìˆœ ì‹ë³„ìš©
            const char = charKeys.find(k => getNick(k) === nick || k === nick) || nick;

            // charKeyë¥¼ ì°¾ê¸° ìœ„í•´ ì—­ì¶”ì í•˜ê±°ë‚˜, headerì— data-char ì†ì„±ì„ ë„£ëŠ”ê²Œ ì¢‹ìŒ.
            // renderPrepGrid ìˆ˜ì • í•„ìš”.
            const grid = header.nextElementSibling;
            if (grid) {
                const isCollapsed = header.classList.contains('collapsed');
                if (isCollapsed) grid.style.display = 'none';
                else grid.style.display = 'grid';
                // ìƒíƒœ ì €ì¥ (data-char ì†ì„±ì´ ì—†ìœ¼ë©´ ë‹‰ë„¤ì„ìœ¼ë¡œë¼ë„ ì €ì¥ ì‹œë„)
                const charKey = header.dataset.char || char;
                localStorage.setItem(`prep_section_collapsed_${charKey}`, isCollapsed);
            }
        }

        function renderPrepGrid() {
            const container = document.getElementById('dynamic-prep-area');
            if (!appData.customPrep) appData.customPrep = [];
            let html = '';

            charKeys.forEach(char => {
                let cardsData = [];

                // 1. ê¸°ë³¸/ì—­í•  ì•„ì´í…œ (ê¸°ì¡´ prepItemsDef ê¸°ë°˜)
                // ë™ì  ê³„ì‚°: appData.cookingì˜ ëª¨ë“  í•­ëª©ì„ ìŠ¤ìº”í•˜ì—¬ ì¬ë£Œ í•©ì‚°
                const baseTotals = {}; // { 'ê³ ê¸°': { qty: 0, sources: [] } }

                appData.cooking[0].items.forEach(cookItem => {
                    const tag = cookItem.tag;
                    if (isTagActive(tag)) {
                        const roles = getRole(tag, cookItem.defaultRole || ['each']);
                        if (roles.includes(char) || roles.includes('each')) {
                            // ì¬ë£Œ íŒŒì‹± (ì˜ˆ: "ê³ ê¸° 70, ìƒí¬ë¦¼ 14")
                            const ings = cookItem.item.split(', ');
                            ings.forEach(ing => {
                                const parts = ing.trim().split(' ');
                                if (parts.length >= 2) {
                                    const qtyStr = parts.pop(); // ë§ˆì§€ë§‰ì´ ìˆ«ì
                                    const name = parts.join(' '); // ë‚˜ë¨¸ì§€ëŠ” ì´ë¦„
                                    const qty = parseInt(qtyStr) || 0;

                                    // ëª¨ë“  ì¬ë£Œë¥¼ baseTotalsì— í•©ì‚° (customPrep ì—¬ë¶€ ìƒê´€ì—†ì´)
                                    if (qty > 0) {
                                        if (!baseTotals[name]) baseTotals[name] = { qty: 0, sources: [] };
                                        baseTotals[name].qty += qty;
                                        const menu = appData.menus.find(m => m.id === tag);
                                        // ë©”ë‰´ ì´ë¦„ì—ì„œ ì²« ë‹¨ì–´ ì¶”ì¶œ (ì˜ˆ: "ğŸŸ ë†ì–´ë§¤ìš´íƒ•" â†’ "ë†ì–´ë§¤ìš´íƒ•")
                                        let shortName = tag;
                                        if (menu) {
                                            const cleanLabel = menu.label.replace(/\s*\(ì£¼ê°„\)/, '').replace(/\s*\(ì¼ì¼\)/, '');
                                            const labelParts = cleanLabel.split(' ');
                                            shortName = labelParts.length > 1 ? labelParts[1] : labelParts[0];
                                        }
                                        baseTotals[name].sources.push(`${shortName}(${qty})`);
                                    }
                                }
                            });
                        }
                    }
                });

                prepItemsDef.forEach(item => {
                    let show = false;
                    let totalQty = 0;
                    let sourceDetails = [];

                    if (item.type === 'static' && item.owner === char) {
                        show = true;
                    } else if (item.type === 'role') {
                        // Role type deprecated in favor of baseTotals calculation but kept for compatibility logic if needed
                    } else if (item.type === 'base') {
                        // baseNameìœ¼ë¡œ ë§¤ì¹­
                        const data = baseTotals[item.baseName];
                        if (data && data.qty > 0) {
                            // customPrepì— ì´ ì¬ë£Œê°€ ìˆëŠ”ì§€ í™•ì¸ (ìˆìœ¼ë©´ ì¤‘ë³µì´ë¯€ë¡œ ê±´ë„ˆëœ€)
                            const existsInCustom = appData.customPrep && appData.customPrep.some(cp => {
                                if (!isTagActive(cp.tag)) return false;
                                const role = getRole(cp.tag, 'each');
                                if (!role.includes(char) && !role.includes('each')) return false;

                                const nameMatch = cp.title.match(/^(?:ğŸŒ¿|ğŸ”¨|ğŸ›’|ğŸ|ğŸ–|ğŸš|ğŸ¥”|ğŸ§‚|ğŸ¥•|ğŸ¥š|ğŸ“¦|ğŸŒ¶ï¸|ğŸ§„|ğŸ§…|ğŸ¥¬|ğŸƒ|ğŸ |ğŸ›|ğŸŸ|ğŸƒ|ğŸ“|ğŸ£|ğŸ› ï¸)?\s*([ê°€-í£a-zA-Z]+)/);
                                let baseName = nameMatch ? nameMatch[1] : '';
                                if (!baseName) {
                                    const parts = cp.title.split(' ');
                                    baseName = parts.length > 1 ? parts[1] : parts[0];
                                }
                                baseName = baseName.replace(/\d+ê°œ?/g, '').trim();

                                return baseName === item.baseName;
                            });

                            if (!existsInCustom) {
                                totalQty = data.qty;
                                sourceDetails = data.sources;
                                show = true;
                            }
                        }
                    }

                    if (show) {
                        const isChecked = localStorage.getItem(`prep_${item.id}_${char}`) === 'true';
                        let finalTitle = item.title.replace('{qty}', totalQty);
                        let finalDesc = item.desc;

                        if (sourceDetails.length > 0) finalDesc = sourceDetails.join(' + ');

                        // Action detection update
                        // ë‚šì‹œ/ì±„ì§‘/êµ¬ë§¤/ì œì‘ íŒë³„
                        let action = 'êµ¬ë§¤';
                        if (finalTitle.includes('ì±„ì§‘')) action = 'ì±„ì§‘';
                        else if (finalTitle.includes('ì œì‘')) action = 'ì œì‘';
                        else if (finalTitle.includes('ë‚šì‹œ')) action = 'ë‚šì‹œ';

                        // ë†ì–´/ì–‘íŒŒ ë“± íŠ¹ìˆ˜ ì¼€ì´ìŠ¤ ë°˜ì˜ (ì´ë¯¸ titleì´ ë³€ê²½ë˜ì—ˆì§€ë§Œ ì•ˆì „ì¥ì¹˜)
                        if (item.baseName === 'ë†ì–´') action = 'ë‚šì‹œ';
                        if (item.baseName === 'ì–‘íŒŒ') action = 'ì±„ì§‘';

                        // ì œëª© ì¬êµ¬ì„± (ìˆ˜ëŸ‰ ë°˜ì˜)
                        const prefix = item.icon || '';
                        const name = item.baseName || finalTitle.split(' ')[1];
                        finalTitle = `${prefix} ${name} ${totalQty}ê°œ ${action}`;

                        cardsData.push({
                            id: item.id,
                            char: char,
                            title: finalTitle,
                            desc: finalDesc,
                            color: item.color,
                            isChecked: isChecked,
                            editable: true,
                            idx: -1,
                            type: 'static'
                        });
                    }
                });

                // 2. ì»¤ìŠ¤í…€ ë° ë ˆì‹œí”¼ ì•„ì´í…œ - baseNameìœ¼ë¡œ í•©ì¹˜ê¸°
                const mergedMap = new Map();
                appData.customPrep.forEach((cp, idx) => {
                    if (isTagActive(cp.tag)) {
                        const role = getRole(cp.tag, 'each');
                        if (role.includes(char) || role.includes('each')) {
                            // baseName ì¶”ì¶œ: ì´ëª¨ì§€, ìˆ«ì, ì•¡ì…˜ ë‹¨ì–´ ì œê±°
                            let baseName = cp.title
                                .replace(/^(([\u{10000}-\u{10FFFF}]|[\u2000-\u3300])[\uFE00-\uFE0F]?)+\s*/u, '') // ì´ëª¨ì§€ ì œê±° (í™•ì¥)
                                .replace(/\d+ê°œ?\s*/g, '') // ìˆ«ìì™€ 'ê°œ' ì œê±°
                                .replace(/\s*(êµ¬ë§¤|ì±„ì§‘|ì œì‘|ë‚šì‹œ)\s*$/, '') // ì•¡ì…˜ ë‹¨ì–´ ì œê±°
                                .trim();

                            // ì´ë¯¸ ì²˜ë¦¬ëœ ì¬ë£Œë©´ ê±´ë„ˆë›°ê¸°
                            if (mergedMap.has(baseName)) return;

                            // baseTotalsì—ì„œ í•©ì‚°ëœ ìˆ˜ëŸ‰ê³¼ ì¶œì²˜ ê°€ì ¸ì˜¤ê¸°
                            const baseData = baseTotals[baseName];
                            const qtyMatch = cp.title.match(/(\d+)ê°œ/);
                            const cpQty = qtyMatch ? parseInt(qtyMatch[1]) : 0;

                            // baseTotalsì— ë°ì´í„°ê°€ ìˆìœ¼ë©´ ê·¸ê²ƒ ì‚¬ìš©, ì—†ìœ¼ë©´ customPrep ë°ì´í„° ì‚¬ìš©
                            const totalQty = baseData ? baseData.qty : cpQty;
                            const sources = baseData ? baseData.sources : [`${cp.tag}(${cpQty})`];

                            mergedMap.set(baseName, {
                                ...cp,
                                totalQty: totalQty,
                                sources: sources,
                                isCustom: !cp.id.includes('_'),
                                firstTitle: cp.title,
                                lastIdx: idx
                            });
                        }
                    }
                });

                mergedMap.forEach((val, key) => {
                    const isChecked = localStorage.getItem(`prep_${val.id}_${char}`) === 'true';
                    // ì²« ë²ˆì§¸ ì•„ì´í…œì˜ íƒ€ì´í‹€ì—ì„œ ì•„ì´ì½˜ê³¼ ì•¡ì…˜ ì¶”ì¶œ
                    const sourceTitle = val.firstTitle || val.title;
                    const prefix = sourceTitle.match(/^([\u{10000}-\u{10FFFF}]|[\u2000-\u3300])[\uFE00-\uFE0F]?/u)?.[0] || 'ğŸ› ï¸';
                    const action = sourceTitle.includes('ì±„ì§‘') ? 'ì±„ì§‘' : (sourceTitle.includes('ì œì‘') ? 'ì œì‘' : (sourceTitle.includes('ë‚šì‹œ') ? 'ë‚šì‹œ' : 'êµ¬ë§¤'));
                    const finalTitle = `${prefix} ${key} ${val.totalQty}ê°œ ${action}`;
                    const finalDesc = val.sources.join(' + ');
                    cardsData.push({
                        id: val.id, char, title: finalTitle, desc: finalDesc, color: val.color, isChecked, editable: true, idx: val.lastIdx, type: val.isCustom ? 'custom' : 'recipe'
                    });
                });

                // íƒ€ì…ë³„ ì •ë ¬: êµ¬ë§¤ â†’ ì±„ì§‘ â†’ ì œì‘ â†’ ë‚šì‹œ ìˆœì„œ
                // ì²´í¬ ìƒíƒœ ìš°ì„ , ê·¸ ë‹¤ìŒ íƒ€ì…ìˆœ
                const typeOrder = { 'êµ¬ë§¤': 1, 'ì±„ì§‘': 2, 'ì œì‘': 3, 'ë‚šì‹œ': 4 };
                cardsData.sort((a, b) => {
                    // íƒ€ì… ì¶”ì¶œ
                    const getType = (title) => {
                        if (title.includes('êµ¬ë§¤')) return 'êµ¬ë§¤';
                        if (title.includes('ì±„ì§‘')) return 'ì±„ì§‘';
                        if (title.includes('ì œì‘')) return 'ì œì‘';
                        if (title.includes('ë‚šì‹œ')) return 'ë‚šì‹œ';
                        return 'ê¸°íƒ€';
                    };

                    // 1ì°¨: ì²´í¬ ìƒíƒœ (ë¯¸ì²´í¬ ë¨¼ì €)
                    if (a.isChecked !== b.isChecked) {
                        return a.isChecked ? 1 : -1;
                    }

                    // 2ì°¨: íƒ€ì… ìˆœì„œ
                    const typeA = getType(a.title);
                    const typeB = getType(b.title);

                    const orderA = typeOrder[typeA] || 999;
                    const orderB = typeOrder[typeB] || 999;

                    return orderA - orderB;
                });

                let cardsHtml = cardsData.map(c => createCardHtml(c.id, c.char, c.title, c.desc, c.color, c.isChecked, c.editable, c.idx, c.type)).join('');

                if (cardsHtml) {
                    // ì²« ë²ˆì§¸ ìºë¦­í„°(ì¸ë±ìŠ¤ 0)ëŠ” ê¸°ë³¸ ì—´ë¦¼, ë‚˜ë¨¸ì§€ëŠ” ê¸°ë³¸ ë‹«í˜
                    const savedState = localStorage.getItem(`prep_section_collapsed_${char}`);
                    const isFirstChar = charKeys.indexOf(char) === 0;
                    const isCollapsed = savedState !== null ? (savedState === 'true') : !isFirstChar;

                    html += `
                    <div class="char-divider ${isCollapsed ? 'collapsed' : ''}" data-char="${char}" onclick="toggleCharSection(this)">${getNick(char)} <span style="font-size:0.8rem; float:right;">â–¼</span></div>
                    <div class="special-grid" style="display:grid; ${isCollapsed ? 'display:none;' : ''}">${cardsHtml}</div>`;
                }
            });
            container.innerHTML = html;
        }

        function renderCommonPrep() {
            const area = document.getElementById('common-prep-area');
            let cardsData = [];

            appData.commonPrep.forEach((cp, idx) => {
                const isChecked = localStorage.getItem(`prep_${cp.id}_common`) === 'true';
                cardsData.push({ ...cp, isChecked, idx });
            });

            // ì •ë ¬
            cardsData.sort((a, b) => (a.isChecked === b.isChecked) ? 0 : a.isChecked ? 1 : -1);

            let cardsHtml = cardsData.map(c => createCardHtml(c.id, 'common', c.title, c.desc, c.color || '#4b5563', c.isChecked, true, c.idx, 'common')).join('');
            area.innerHTML = cardsHtml || '<p style="text-align:center; width:100%; opacity:0.5; font-size:0.8rem;">í™œì„±í™”ëœ ê³µí†µ ì¤€ë¹„ë¬¼ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
        }

        function createCardHtml(id, char, title, desc, color, isChecked, editable, idx, type) {
            let actions = '';
            if (editable) {
                actions = `
                    <div class="card-actions" onclick="event.stopPropagation();">
                        <button class="card-action-btn" onclick="openPrepEditModal('${id}', ${idx}, '${type}')">âœï¸</button>
                    </div>
                `;
            }
            return `
                <div class="card ${isChecked ? 'checked' : ''}" draggable="${type === 'custom' ? 'true' : 'false'}" 
                     ondragstart="handlePrepDragStart(event, ${idx})" ondragover="handlePrepDragOver(event)" ondrop="handlePrepDrop(event, ${idx})" 
                     onclick="togglePrep('${id}', '${char}')">
                    ${actions}
                    <div class="card-content">
                        <h3 style="color:${color}">${title}</h3>
                        <p>${desc}</p>
                    </div>
                    <div class="prep-check-circle"></div>
                </div>
            `;
        }

        // --- ì¤€ë¹„ë¬¼ ë“œë˜ê·¸ ì•¤ ë“œë¡­ (ì»¤ìŠ¤í…€ ì „ìš©) ---
        let prepDragSrcIdx = null;
        function handlePrepDragStart(e, idx) {
            if (idx === undefined) { e.preventDefault(); return; }
            prepDragSrcIdx = idx;
            e.dataTransfer.effectAllowed = 'move';
        }
        function handlePrepDragOver(e) { e.preventDefault(); e.dataTransfer.dropEffect = 'move'; return false; }
        function handlePrepDrop(e, targetIdx) {
            e.stopPropagation();
            if (prepDragSrcIdx !== null && targetIdx !== undefined && prepDragSrcIdx !== targetIdx) {
                const item = appData.customPrep.splice(prepDragSrcIdx, 1)[0];
                appData.customPrep.splice(targetIdx, 0, item);
                saveData();
                refreshAll();
            }
            return false;
        }

        // --- ì¤€ë¹„ë¬¼ í¸ì§‘ ë¡œì§ ---
        function openPrepEditModal(id, idx, type) {
            document.getElementById('edit-prep-id').value = id; // use ID now
            document.getElementById('edit-prep-type').value = type;

            const titleInp = document.getElementById('prep-title');
            const descInp = document.getElementById('prep-desc');
            const colorInp = document.getElementById('prep-color');
            const titleGroup = document.getElementById('prep-title-group');
            const colorGroup = document.getElementById('prep-color-group');
            const delBtn = document.getElementById('prep-del-btn');

            if (type === 'custom') {
                const item = appData.customPrep[idx];
                titleInp.value = item.title;
                descInp.value = item.desc;
                colorInp.value = item.color || '#374151';
                titleGroup.style.display = 'block';
                document.getElementById('prep-icon-group').style.display = 'block';
                colorGroup.style.display = 'block';
                delBtn.style.display = 'block';
            } else if (type === 'recipe') {
                const item = appData.customPrep[idx];
                titleInp.value = item.title;
                descInp.value = item.desc;
                colorInp.value = item.color || '#374151';
                titleGroup.style.display = 'none';
                document.getElementById('prep-icon-group').style.display = 'block';
                colorGroup.style.display = 'block';
                delBtn.style.display = 'none';
            } else if (type === 'common') {
                const item = appData.commonPrep[idx];
                titleInp.value = item.title;
                descInp.value = item.desc;
                colorInp.value = item.color || '#4b5563';
                titleGroup.style.display = 'block';
                document.getElementById('prep-icon-group').style.display = 'block';
                colorGroup.style.display = 'block';
                delBtn.style.display = 'block';
            } else if (type === 'static') {
                const item = prepItemsDef.find(i => i.id === id);
                let displayTitle = item.title || '';
                // ì œëª© í…œí”Œë¦¿ì˜ ê¸°ì¡´ ì•„ì´ì½˜ì„ í˜„ì¬ ì„¤ì •ëœ ì•„ì´ì½˜ìœ¼ë¡œ êµì²´
                if (item.icon) {
                    displayTitle = displayTitle.replace(/^(([\u{10000}-\u{10FFFF}]|[\u2000-\u3300])[\uFE00-\uFE0F]?)+\s*/u, '');
                    displayTitle = item.icon + ' ' + displayTitle;
                }
                titleInp.value = displayTitle;
                descInp.value = item.desc || '';
                colorInp.value = item.color || '#374151';
                titleGroup.style.display = 'none'; // Still hide title for static/base as it's auto-gen
                document.getElementById('prep-icon-group').style.display = 'block';
                colorGroup.style.display = 'block';
                delBtn.style.display = 'none';
            }

            document.getElementById('prep-modal').classList.add('open');
        }



        function closePrepModal() { document.getElementById('prep-modal').classList.remove('open'); }

        function savePrepEdit() {
            const id = document.getElementById('edit-prep-id').value;
            const type = document.getElementById('edit-prep-type').value;
            const newTitle = document.getElementById('prep-title').value;
            const newDesc = document.getElementById('prep-desc').value;
            const newColor = document.getElementById('prep-color').value;

            if (type === 'custom' || type === 'recipe' || type === 'common') {
                if (type === 'recipe') {
                    const baseName = newTitle.replace(/ \d+ê°œ (ì±„ì§‘|ì œì‘|êµ¬ë§¤|ë‚šì‹œ)$/, '').replace(/^(([\u{10000}-\u{10FFFF}]|[\u2000-\u3300])[\uFE00-\uFE0F]?)+\s*/u, '');
                    appData.customPrep.forEach(cp => {
                        const cpBaseName = cp.title.replace(/ \d+ê°œ (ì±„ì§‘|ì œì‘|êµ¬ë§¤|ë‚šì‹œ)$/, '').replace(/^(([\u{10000}-\u{10FFFF}]|[\u2000-\u3300])[\uFE00-\uFE0F]?)+\s*/u, '');
                        if (cpBaseName === baseName) {
                            cp.desc = newDesc;
                            cp.color = newColor;
                            // ì•„ì´ì½˜ ì—…ë°ì´íŠ¸
                            const newIcon = newTitle.match(/^([\u{10000}-\u{10FFFF}]|[\u2000-\u3300])[\uFE00-\uFE0F]?/u)?.[0];
                            if (newIcon) {
                                cp.title = cp.title.replace(/^(([\u{10000}-\u{10FFFF}]|[\u2000-\u3300])[\uFE00-\uFE0F]?)+/u, newIcon);
                            }
                        }
                    });
                } else if (type === 'common') {
                    const idx = appData.commonPrep.findIndex(p => p.id === id);
                    if (idx !== -1) {
                        appData.commonPrep[idx].title = newTitle;
                        appData.commonPrep[idx].desc = newDesc;
                        appData.commonPrep[idx].color = newColor;
                    }
                } else {
                    const idx = appData.customPrep.findIndex(p => p.id === id);
                    if (idx !== -1) {
                        appData.customPrep[idx].title = newTitle;
                        appData.customPrep[idx].desc = newDesc;
                        appData.customPrep[idx].color = newColor;
                    }
                }
            } else {
                // static/base íƒ€ì… - prepItemsDefì™€ localStorageì— ì €ì¥
                const item = prepItemsDef.find(i => i.id === id);
                if (item) {
                    item.desc = newDesc;
                    item.color = newColor;
                    // ì•„ì´ì½˜ ì—…ë°ì´íŠ¸
                    const newIcon = newTitle.match(/^([\u{10000}-\u{10FFFF}]|[\u2000-\u3300])[\uFE00-\uFE0F]?/u)?.[0];
                    if (newIcon) item.icon = newIcon;

                    localStorage.setItem(`prep_desc_${id}`, newDesc);
                    localStorage.setItem(`prep_color_${id}`, newColor);
                    if (newIcon) localStorage.setItem(`prep_icon_${id}`, newIcon);
                }
            }
            saveData();
            refreshAll();
            closePrepModal();
        }

        function deletePrepItem() {
            showConfirm('í•´ë‹¹ ì¤€ë¹„ë¬¼ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?', () => {
                const id = document.getElementById('edit-prep-id').value;
                const type = document.getElementById('edit-prep-type').value;
                if (type === 'common') {
                    appData.commonPrep = appData.commonPrep.filter(p => p.id !== id);
                } else {
                    appData.customPrep = appData.customPrep.filter(p => p.id !== id);
                }
                saveData();
                refreshAll();
                closePrepModal();
            });
        }

        function openCommonPrepModal() {
            const id = `common_${Date.now()}`;
            appData.commonPrep.push({ id, title: 'ìƒˆ ê³µí†µ ì¤€ë¹„ë¬¼', desc: 'ì„¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”', color: '#4b5563' });
            saveData();
            refreshAll();
            openPrepEditModal(id, appData.commonPrep.length - 1, 'common');
        }

        function setPrepIcon(icon) {
            const id = document.getElementById('edit-prep-id').value;
            const type = document.getElementById('edit-prep-type').value;
            const titleInp = document.getElementById('prep-title');

            if (type === 'static') {
                localStorage.setItem(`prep_icon_${id}`, icon);
                const item = prepItemsDef.find(i => i.id === id);
                if (item) item.icon = icon;

                // ì œëª© ì…ë ¥ í•„ë“œë„ ì—…ë°ì´íŠ¸
                let current = titleInp.value.trim();
                // ëª¨ë“  ì´ëª¨ì§€ ì œê±° (ë” í¬ê´„ì ì¸ ë²”ìœ„)
                current = current.replace(/^[\u{1F000}-\u{1FFFF}\u{2000}-\u{3300}\u{E000}-\u{F8FF}]([\uFE00-\uFE0F]|\u{E0100}-\u{E01EF})?\s*/u, '');
                titleInp.value = icon + ' ' + current;
            } else {
                let current = titleInp.value.trim();
                // ëª¨ë“  ì´ëª¨ì§€ ì œê±° (ë” í¬ê´„ì ì¸ ë²”ìœ„)
                current = current.replace(/^[\u{1F000}-\u{1FFFF}\u{2000}-\u{3300}\u{E000}-\u{F8FF}]([\uFE00-\uFE0F]|\u{E0100}-\u{E01EF})?\s*/u, '');
                titleInp.value = icon + ' ' + current;
                // Also save icon separately if we want to extract it later
                localStorage.setItem(`prep_icon_${id}`, icon);
            }
        }

        function getRole(tag, defaultVal) {
            let itemId = null;
            appData.cooking[0].items.forEach(i => { if (i.tag === tag) itemId = i.id; });
            if (!itemId) return defaultVal;
            const saved = localStorage.getItem(`role_${itemId}`);
            return saved ? JSON.parse(saved) : defaultVal;
        }

        function togglePrep(itemId, char) {
            const key = `prep_${itemId}_${char}`;
            const isChecked = localStorage.getItem(key) === 'true';
            localStorage.setItem(key, !isChecked);
            refreshAll();
        }

        // --- ëª¨ë‹¬ ë¡œì§ ---
        function openModal() {
            document.getElementById('modal-title').innerText = 'â• ìƒˆ ë©”ë‰´ ì¶”ê°€';
            document.getElementById('edit-tag-id').value = '';
            document.getElementById('add-menu-name').value = '';
            document.getElementById('add-npc').value = '';
            document.getElementById('add-give-qty').value = '';
            document.getElementById('add-reward').value = '';
            document.getElementById('add-reward-qty').value = '';
            document.getElementById('add-menu-name').disabled = false;

            document.getElementById('add-modal').classList.add('open');
            document.getElementById('ing-list').innerHTML = '';
            addIngRow();
        }

        function openEditModal(tagId) {
            const menu = appData.menus.find(m => m.id === tagId);
            if (!menu) return;

            // ëª¨ë“  í•„ë“œ ì´ˆê¸°í™” (ì´ì „ ìˆ˜ì • ë°ì´í„° ì œê±°)
            document.getElementById('add-cycle').value = 'weekly';
            document.getElementById('add-village').value = 'ì´ë©˜ë§ˆí•˜';
            document.getElementById('add-npc').value = '';
            document.getElementById('add-give-qty').value = '';
            document.getElementById('add-reward').value = '';
            document.getElementById('add-reward-qty').value = '';

            document.getElementById('modal-title').innerText = 'âœï¸ ë©”ë‰´ ìˆ˜ì •';
            document.getElementById('edit-tag-id').value = tagId;
            document.getElementById('add-menu-name').value = menu.label.replace(' (ì¼ì¼)', '').replace(' (ì£¼ê°„)', '');
            document.getElementById('add-menu-name').disabled = false;

            // ìš”ë¦¬ ì •ë³´ì—ì„œ giveQty ì¶”ì¶œ
            const cookItem = appData.cooking[0].items.find(i => i.tag === tagId);
            if (cookItem) {
                const qtyMatch = cookItem.npc.match(/\((\d+)ê°œ\)/);
                if (qtyMatch) document.getElementById('add-give-qty').value = qtyMatch[1];
            }

            // ì €ì¥ëœ ë©”ë‰´ ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸° (appData.menusì— ì €ì¥ëœ ì •ë³´ ì‚¬ìš©)
            if (menu.npc) document.getElementById('add-npc').value = menu.npc;
            if (menu.giveQty) document.getElementById('add-give-qty').value = menu.giveQty;
            if (menu.reward) document.getElementById('add-reward').value = menu.reward;
            if (menu.rewardQty) document.getElementById('add-reward-qty').value = menu.rewardQty;
            if (menu.cycle) document.getElementById('add-cycle').value = menu.cycle;
            if (menu.village) document.getElementById('add-village').value = menu.village;

            // í•˜ìœ„ í˜¸í™˜ì„± ë° ê¸°ì¡´ ë°ì´í„° ë¡œë“œ (í•„ìš”í•œ ê²½ìš°ë§Œ ìœ ì§€, ì—°ê²° í•´ì œ í›„ì—ëŠ” ë¶ˆí•„ìš”í•  ìˆ˜ ìˆìœ¼ë‚˜ ì•ˆì „ì¥ì¹˜)
            // ì´ë¯¸ ë©”ë‰´ ê°ì²´ì— ë°ì´í„°ê°€ ìˆë‹¤ë©´ ìœ„ì—ì„œ ë¡œë“œë¨. ì—†ë‹¤ë©´(êµ¬ë²„ì „ ë°ì´í„°) ì•„ë˜ ë¡œì§ìœ¼ë¡œ ì°¾ì•„ë³¼ ìˆ˜ë„ ìˆìŒ.
            // í•˜ì§€ë§Œ ì‚¬ìš©ìê°€ 'ì´ˆê¸°í™”ëœë‹¤'ê³  í–ˆìœ¼ë¯€ë¡œ, ìœ„ ì½”ë“œë¡œ ì €ì¥ì´ ì˜ ë˜ì—ˆë‹¤ë©´ ì´ì œ ì˜ ë¶ˆëŸ¬ì™€ì§ˆ ê²ƒì„.
            // ê¸°ì¡´ Exchange ê²€ìƒ‰ ë¡œì§ì€ ì œê±°í•˜ì—¬ í˜¼ë€ ë°©ì§€.

            // ì¬ë£Œ ëª©ë¡ êµ¬ì„±
            document.getElementById('ing-list').innerHTML = '';

            // êµ¬ë§¤ ì¬ë£Œ (ì‡¼í•‘ì—ì„œ í•´ë‹¹ íƒœê·¸ ê´€ë ¨ ì•„ì´í…œ ì°¾ê¸° - í…ìŠ¤íŠ¸ ë§¤ì¹­ì´ë¼ í•œê³„ê°€ ìˆì§€ë§Œ ìµœì„ )
            // êµ¬ë§¤ ì¬ë£Œ (ì‡¼í•‘ì—ì„œ í•´ë‹¹ íƒœê·¸ ê´€ë ¨ ì•„ì´í…œ ì°¾ê¸°)
            if (cookItem) {
                const ings = cookItem.item.split(', ');
                ings.forEach(ingStr => {
                    const parts = ingStr.trim().split(' ');
                    const totalQty = parts.pop(); // last is qty
                    const name = parts.join(' '); // rest is name
                    const giveQty = parseInt(document.getElementById('add-give-qty').value) || 1;
                    const unitQty = Math.ceil(parseInt(totalQty) / giveQty);

                    // ê¸°ë³¸ê°’: prepItemsDef ì°¸ê³ 
                    let foundType = 'gather';
                    let foundVillage = 'ì´ë©˜ ë§ˆí•˜';
                    let foundNpc = '';

                    const baseDef = prepItemsDef.find(p => p.baseName === name);
                    if (baseDef) {
                        if (baseDef.icon === 'ğŸ£' || baseDef.title.includes('ë‚šì‹œ')) foundType = 'fishing';
                        else if (baseDef.title.includes('ì œì‘')) foundType = 'craft';
                        else if (baseDef.title.includes('êµ¬ë§¤')) foundType = 'shop';
                    }

                    // customPrepì—ì„œ ì´ ë©”ë‰´ì˜ ì¬ë£Œ íƒ€ì… í™•ì¸ (ì €ì¥ëœ ê°’ ìš°ì„ )
                    if (tagId && appData.customPrep) {
                        const customItem = appData.customPrep.find(cp => cp.tag === tagId && cp.title.includes(name));
                        if (customItem) {
                            if (customItem.title.includes('ë‚šì‹œ')) foundType = 'fishing';
                            else if (customItem.title.includes('ì œì‘')) foundType = 'craft';
                            else if (customItem.title.includes('êµ¬ë§¤')) foundType = 'shop';
                            else if (customItem.title.includes('ì±„ì§‘')) foundType = 'gather';

                            // ì €ì¥ëœ ë§ˆì„/NPC ì •ë³´ ë³µêµ¬ (ê°’ì´ ìˆì„ ê²½ìš°ì—ë§Œ)
                            if (customItem.village) foundVillage = customItem.village;
                            if (customItem.npc) foundNpc = customItem.npc;
                        }
                    }

                    appData.shopping.forEach(group => {
                        group.items.forEach(si => {
                            if (si.item.includes(name)) {
                                foundType = 'shop';
                                foundVillage = group.village;
                                foundNpc = si.npc;
                            }
                        });
                    });

                    addIngRowWithData(foundType, foundVillage, foundNpc, name, unitQty);
                });
            }

            document.getElementById('add-modal').classList.add('open');
        }

        function addIngRowWithData(type, village, npc, name, qty) {
            addIngRow();
            const rows = document.querySelectorAll('.ing-row');
            const row = rows[rows.length - 1];
            row.querySelector('.ing-type').value = type;
            row.querySelector('.ing-village').value = village;
            row.querySelector('.ing-npc').value = npc;
            row.querySelector('.ing-name').value = name;
            row.querySelector('.ing-qty').value = qty;
            toggleIngType(row.querySelector('.ing-type'));
        }
        function closeModal() { document.getElementById('add-modal').classList.remove('open'); }

        function addIngRow() {
            const div = document.createElement('div');
            div.className = 'ing-row';
            div.innerHTML = `
            <select class="ing-type" onchange="toggleIngType(this)">
                <option value="shop">êµ¬ë§¤</option>
                <option value="gather">ì±„ì§‘</option>
                <option value="craft">ì œì‘</option>
                <option value="fishing">ë‚šì‹œ</option>
            </select>
            <select class="ing-village" style="display:block;">
                <option value="ì´ë©˜ë§ˆí•˜">ì´ë©˜ë§ˆí•˜</option>
                <option value="ë°˜í˜¸ë¥´">ë°˜í˜¸ë¥´</option>
                <option value="ë˜ë°”íŠ¼">ë˜ë°”íŠ¼</option>
                <option value="í‹°ë¥´ì½”ë„¤ì¼">í‹°ë¥´ì½”ë„¤ì¼</option>
                <option value="ì½œí—¨">ì½œí—¨</option>
            </select>
            <input type="text" placeholder="NPC" class="ing-npc" style="display:block;">
            <input type="text" placeholder="ì¬ë£Œëª…" class="ing-name">
            <input type="number" placeholder="ê°œ" class="ing-qty" min="0">
            <button class="ing-btn-del" onclick="this.parentElement.remove()">Ã—</button>
        `;
            document.getElementById('ing-list').appendChild(div);
        }

        window.toggleIngType = function (select) {
            const row = select.parentElement;
            const v = row.querySelector('.ing-village');
            const n = row.querySelector('.ing-npc');
            if (select.value === 'shop') { v.style.display = 'block'; n.style.display = 'block'; }
            else if (select.value === 'craft' || select.value === 'fishing') { v.style.display = 'none'; n.style.display = 'none'; }
            else { v.style.display = 'none'; n.style.display = 'none'; }
        }

        function addItem() {
            const menuName = document.getElementById('add-menu-name').value.trim();
            const cycle = document.getElementById('add-cycle').value;
            const targetNpc = document.getElementById('add-npc').value.trim();
            const village = document.getElementById('add-village').value;
            const giveQty = parseInt(document.getElementById('add-give-qty').value) || 0;
            const reward = document.getElementById('add-reward').value.trim();
            const rewardQty = document.getElementById('add-reward-qty').value.trim();
            const editTagId = document.getElementById('edit-tag-id').value;

            // ëª¨ë“  í•„ë“œì˜ ë¹¨ê°„ í…Œë‘ë¦¬ ì œê±° (ì´ì „ ì—ëŸ¬ í‘œì‹œ ì´ˆê¸°í™”)
            document.getElementById('add-menu-name').style.border = '';
            document.getElementById('add-npc').style.border = '';
            document.getElementById('add-give-qty').style.border = '';
            document.getElementById('add-reward').style.border = '';

            if (!menuName || !targetNpc || !giveQty || !reward) {
                // ë¹ˆ í•„ë“œì— ë¹¨ê°„ í…Œë‘ë¦¬ ì¶”ê°€
                if (!menuName) document.getElementById('add-menu-name').style.border = '2px solid #ef4444';
                if (!targetNpc) document.getElementById('add-npc').style.border = '2px solid #ef4444';
                if (!giveQty) document.getElementById('add-give-qty').style.border = '2px solid #ef4444';
                if (!reward) document.getElementById('add-reward').style.border = '2px solid #ef4444';

                // ëª¨ë‹¬ í”ë“¤ê¸° ì• ë‹ˆë©”ì´ì…˜
                const modal = document.querySelector('#add-modal .modal');
                modal.style.animation = 'shake 0.5s';
                setTimeout(() => { modal.style.animation = ''; }, 500);

                // ìƒì„¸ ì—ëŸ¬ ë©”ì‹œì§€
                const missing = [];
                if (!menuName) missing.push('ë©”ë‰´ëª…');
                if (!targetNpc) missing.push('êµí™˜ NPC');
                if (!giveQty) missing.push('ê±´ë„¤ì¤„ ê°œìˆ˜');
                if (!reward) missing.push('ë³´ìƒ');

                return alert(`âŒ í•„ìˆ˜ ì…ë ¥ê°’ì´ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤!

ë¹ ì§„ í•­ëª©: ${missing.join(', ')}

í˜„ì¬ ì…ë ¥ê°’:
- ë©”ë‰´ëª…: "${menuName || '(ë¹ˆì¹¸)'}"  
- êµí™˜ NPC: "${targetNpc || '(ë¹ˆì¹¸)'}"
- ê±´ë„¤ì¤„ ê°œìˆ˜: ${giveQty || '(ë¹ˆì¹¸)'}
- ë³´ìƒ: "${reward || '(ë¹ˆì¹¸)'}"

ë¹¨ê°„ í…Œë‘ë¦¬ê°€ í‘œì‹œëœ ì¹¸ì„ ì±„ì›Œì£¼ì„¸ìš”!`);
            }

            const tagId = editTagId || menuName.toLowerCase().replace(/\s/g, '_');

            // ê¸°ì¡´ ë°ì´í„° ì‚­ì œ (ìˆ˜ì •ì¸ ê²½ìš°)
            if (editTagId) {
                // 1. ì‡¼í•‘ ì•„ì´í…œì—ì„œ í•´ë‹¹ ì¬ë£Œë“¤ ì œê±° (í…ìŠ¤íŠ¸ ì œê±°ë¼ ë³µì¡í•¨)
                // ë‹¨ìˆœíˆ ë‹¤ì‹œ ê·¸ë¦°ë‹¤ë©´ ê¸°ì¡´ ì‡¼í•‘ ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í•˜ê³  ë‹¤ì‹œ ë„£ëŠ”ê²Œ ì¢‹ìœ¼ë‚˜, 
                // ì—¬ê¸°ì„œëŠ” ê¸°ì¡´ 'addItem'ê³¼ ë³´ì¡°ë¥¼ ë§ì¶”ê¸° ìœ„í•´ tag ê¸°ë°˜ ì •ë¦¬ê°€ í•„ìš”í•¨.
                // í•˜ì§€ë§Œ í˜„ì¬ ì‡¼í•‘ êµ¬ì¡°ìƒ tagê°€ ì—†ìœ¼ë¯€ë¡œ ìƒëµí•˜ê±°ë‚˜, ì´ë²ˆ ê¸°íšŒì— ëª¨ë“  ë°ì´í„°ë¥¼ tag ê¸°ë°˜ìœ¼ë¡œ ê´€ë¦¬í•˜ë„ë¡ ê°œì„ í•´ì•¼ í•¨.
                // ì¼ë‹¨ ìˆ˜ë™ ì¶”ê°€ëœ í•­ëª©ë§Œì´ë¼ë„ ë®ì–´ì“°ê¸° ìœ„í•´ Cooking, ExchangeëŠ” tagë¡œ í•„í„°ë§ ê°€ëŠ¥.
                appData.cooking[0].items = appData.cooking[0].items.filter(i => i.tag !== tagId);
                appData.weekly.forEach(g => g.items = g.items.filter(i => i.tag !== tagId));
                appData.daily.forEach(g => g.items = g.items.filter(i => i.tag !== tagId));
                if (appData.customPrep) appData.customPrep = appData.customPrep.filter(i => i.tag !== tagId);

                // ì‡¼í•‘ í•­ëª© ì •ë¦¬ëŠ” ì•„ì´í…œ ë§¤ì¹­ìœ¼ë¡œ ì‹œë„ (ìœ„í—˜í•˜ì§€ë§Œ í˜„ì¬ êµ¬ì¡°ìƒ ìµœì„ )
                // ì‹¤ì œ ìƒìš© ì•±ì´ë¼ë©´ ì‡¼í•‘ ì•„ì´í…œì—ë„ tagë¥¼ ë¶™ì˜€ì–´ì•¼ í•¨.
            }

            const ingRows = document.querySelectorAll('.ing-row');
            let ingDesc = [];

            if (!appData.menus.find(m => m.id === tagId)) {
                appData.menus.push({
                    id: tagId,
                    label: menuName + (cycle === 'daily' ? ' (ì¼ì¼)' : ' (ì£¼ê°„)'),
                    npc: targetNpc,
                    village: village,
                    cycle: cycle,
                    giveQty: giveQty,
                    reward: reward,
                    rewardQty: rewardQty
                });
            } else {
                const m = appData.menus.find(m => m.id === tagId);
                m.label = menuName + (cycle === 'daily' ? ' (ì¼ì¼)' : ' (ì£¼ê°„)');
                m.npc = targetNpc;
                m.village = village;
                m.cycle = cycle;
                m.giveQty = giveQty;
                m.reward = reward;
                m.rewardQty = rewardQty;
            }

            ingRows.forEach(row => {
                const name = row.querySelector('.ing-name').value.trim();
                const qty = row.querySelector('.ing-qty').value.trim();
                const type = row.querySelector('.ing-type').value;

                if (name && qty) {
                    const totalQty = parseInt(qty) * giveQty;
                    ingDesc.push(`${name} ${totalQty}`);

                    // ìˆ˜ì •ì‚¬í•­: ê¸°ë³¸ ì •ì˜ ì—¬ë¶€ ìƒê´€ì—†ì´ menu editorì—ì„œ ì§€ì •í•˜ë©´ customPrepì— ì €ì¥ (Override)
                    // const isKnownBase = prepItemsDef.some(p => p.baseName === name);

                    if (type === 'shop' || type === 'gather' || type === 'craft' || type === 'fishing') {
                        if (!appData.customPrep) appData.customPrep = [];
                        let prefix = 'ğŸ”¨';
                        let action = 'ì œì‘';
                        let color = '#8b5cf6';

                        if (type === 'gather') { prefix = 'ğŸŒ¿'; action = 'ì±„ì§‘'; color = '#15803d'; }
                        else if (type === 'shop') { prefix = 'ğŸ›’'; action = 'êµ¬ë§¤'; color = '#b45309'; }
                        if (type === 'fishing') { prefix = 'ğŸ£'; action = 'ë‚šì‹œ'; color = '#3b82f6'; }

                        // ë§ˆì„/NPC ì •ë³´ ì¶”ì¶œ
                        const rowVillage = row.querySelector('.ing-village').value;
                        const rowNpc = row.querySelector('.ing-npc').value;

                        appData.customPrep.push({
                            id: tagId + '_' + name + '_' + Date.now(),
                            type: 'base',
                            owner: 'main',
                            title: `${prefix} ${name} ${totalQty}ê°œ ${action}`,
                            desc: `${menuName}ìš©`,
                            color: color,
                            tag: tagId,
                            village: rowVillage, // ì €ì¥
                            npc: rowNpc          // ì €ì¥
                        });
                    }
                }
            });

            // ìš”ë¦¬
            appData.cooking[0].items.push({
                id: editTagId ? (appData.cooking[0].items.find(i => i.tag === tagId)?.id || `c_${Date.now()}`) : `c_${Date.now()}`,
                npc: `${menuName} (${giveQty}ê°œ)`,
                item: ingDesc.length > 0 ? ingDesc.join(', ') : 'ì¬ë£Œ ì—†ìŒ',
                tag: tagId,
                defaultRole: ['each']
            });

            // êµí™˜ - ë©”ë‰´ ì—ë””í„°ì™€ ì—°ê²° í•´ì œ (ì£¼ê°„êµí™˜ì€ ë³„ë„ë¡œ ê´€ë¦¬)
            // ì‚¬ìš©ìê°€ ì›í•˜ë©´ ì£¼ê°„êµí™˜ íƒ­ì—ì„œ ì§ì ‘ ì¶”ê°€/ê´€ë¦¬í•  ìˆ˜ ìˆìŒ
            // const list = cycle === 'weekly' ? appData.weekly : appData.daily;
            // let group = list.find(g => g.village === village);
            // if (!group) { group = { village: village, items: [] }; list.push(group); }
            // group.items.push({ npc: targetNpc, item: `${menuName}, ${giveQty}ê°œ â†’ ${reward}, ${rewardQty}ê°œ`, tag: tagId });

            saveData();
            closeModal();
            renderMenuToggles();
            refreshAll();

            // ë©”ë‰´ ê´€ë¦¬ ëª¨ë‹¬ì´ ì—´ë ¤ìˆë‹¤ë©´ ëª©ë¡ ìƒˆë¡œê³ ì¹¨ (ìˆ˜ì • ë²„íŠ¼ì´ ê³„ì† ì‘ë™í•˜ë„ë¡)
            const menuManagerModal = document.getElementById('menu-manager-modal');
            if (menuManagerModal && menuManagerModal.classList.contains('open')) {
                renderMenuManageList();
            }

            alert(editTagId ? 'ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤!' : 'ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!');
        }

        // --- ê³µí†µ ---
        function renderHeaders() {
            const tables = [
                { id: 'table-shopping', type: 'shop', title: 'ğŸ›ï¸ ì£¼ê°„êµ¬ë§¤' },
                { id: 'table-cooking', type: 'cook', title: 'ğŸ³ ìš”ë¦¬ì œì‘' },
                { id: 'table-weekly', type: 'week', title: 'ğŸ“¦ ì£¼ê°„êµí™˜' },
                { id: 'table-daily', type: 'day', title: 'ğŸ”„ ì¼ì¼êµí™˜' }
            ];
            tables.forEach(tDef => {
                const table = document.getElementById(tDef.id);
                if (!table) return;

                // thead ì´ˆê¸°í™” ë°©ì§€ ë˜ëŠ” ë®ì–´ì“°ê¸°
                let thead = table.querySelector('thead');
                if (!thead) {
                    thead = document.createElement('thead');
                    table.prepend(thead);
                }

                let thContent = '';
                if (tDef.type === 'cook') {
                    thContent = 'NPC / í•­ëª©';
                } else {
                    // ê´€ë¦¬ ë²„íŠ¼ ì¶”ê°€
                    thContent = `<div style="display:flex; align-items:center; gap:5px;">
                        <span>NPC / í•­ëª©</span>
                        <button class="btn-mini-del" style="background:#e5e7eb; color:#374151; padding:2px 6px; font-size:0.75rem;" onclick="openManageModal('${tDef.type}')">âš™ï¸ ê´€ë¦¬</button>
                    </div>`;
                }

                let ths = `<tr><th>${thContent}</th>`;
                // charKeysëŠ” init()ì—ì„œ ì„¸íŒ…ë¨
                charKeys.forEach(k => {
                    const charName = appData.characters.find(c => c.id === k)?.name || k;
                    // í—¤ë”ì—ì„œ ë°”ë¡œ ìˆ˜ì • ê°€ëŠ¥í•˜ë„ë¡ input ìœ ì§€ (ì„ íƒì‚¬í•­)
                    // ìºë¦­í„° ê´€ë¦¬ ëª¨ë‹¬ì—ì„œ ìˆ˜ì •í•˜ì§€ë§Œ, ì—¬ê¸°ì„œë„ ë˜ë©´ í¸ë¦¬í•¨.
                    ths += `<th><input type="text" class="name-input" value="${charName}" onchange="updateCharName('${k}', this.value)" /></th>`;
                });
                ths += `</tr>`;
                thead.innerHTML = ths;
            });
        }

        function updateNicknames(val, key) {
            localStorage.setItem(`nick_${key}`, val);
            document.querySelectorAll(`input[id^='input-${key}']`).forEach(inp => inp.value = val);
            refreshAll();
        }
        function getNick(key) {
            return appData.characters.find(c => c.id === key)?.name || key;
        }

        // ìºë¦­í„° ê´€ë¦¬ ê¸°ëŠ¥
        function openCharManager() {
            renderCharList();
            document.getElementById('char-modal').classList.add('open');
        }
        function renderCharList() {
            const area = document.getElementById('char-list');
            area.innerHTML = '';
            appData.characters.forEach((c, idx) => {
                const div = document.createElement('div');
                div.className = 'manage-item';
                div.innerHTML = `
                    <div class="manage-item-info">
                         <input type="text" class="form-input" value="${c.name}" onchange="updateCharName('${c.id}', this.value)" style="width:100%; height:30px;">
                    </div>
                    <button class="btn-mini-del" onclick="deleteChar('${c.id}')">ì‚­ì œ</button>
                `;
                area.appendChild(div);
            });
        }
        function updateCharName(id, val) {
            const t = appData.characters.find(c => c.id === id);
            if (t) t.name = val;
            saveData();
            refreshAll();
            renderHeaders();
        }
        function deleteChar(id) {
            if (appData.characters.length <= 1) return alert('ìµœì†Œ 1ëª…ì˜ ìºë¦­í„°ëŠ” í•„ìš”í•©ë‹ˆë‹¤.');
            showConfirm('ìºë¦­í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ê´€ë ¨ ë°ì´í„°ê°€ ì´ˆê¸°í™”ë©ë‹ˆë‹¤.', () => {
                appData.characters = appData.characters.filter(c => c.id !== id);
                saveData();
                init(); // Re-init charKeys
                renderCharList();
            });
        }
        function addChar() {
            const name = document.getElementById('new-char-name').value.trim();
            if (!name) return;
            const id = 'sub' + Date.now();
            appData.characters.push({ id, name });
            document.getElementById('new-char-name').value = '';
            saveData();
            init(); // Re-init charKeys
            renderCharList();
        }

        // ë©”ë‰´ ê´€ë¦¬ ê¸°ëŠ¥
        function openMenuManager() {
            renderMenuManageList();
            document.getElementById('menu-manager-modal').classList.add('open');
        }
        function closeMenuManager() {
            document.getElementById('menu-manager-modal').classList.remove('open');
        }
        function renderMenuManageList() {
            const area = document.getElementById('menu-manage-list');
            area.innerHTML = '';
            appData.menus.forEach((menu, idx) => {
                const div = document.createElement('div');
                div.className = 'manage-item';
                div.innerHTML = `
                    <div class="manage-item-info">
                        <div style="font-weight:500;">${menu.label}</div>
                    </div>
                    <button class="btn-mini-edit" onclick="openEditModal('${menu.id}'); closeMenuManager();">ìˆ˜ì •</button>
                    <button class="btn-mini-del" onclick="deleteMenu('${menu.id}')">ì‚­ì œ</button>
                `;
                area.appendChild(div);
            });
        }
        function deleteMenu(tagId) {
            showConfirm('ë©”ë‰´ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ê´€ë ¨ ë°ì´í„°ê°€ ëª¨ë‘ ì‚­ì œë©ë‹ˆë‹¤.', () => {
                // Remove from menus
                appData.menus = appData.menus.filter(m => m.id !== tagId);
                // Remove from cooking
                appData.cooking[0].items = appData.cooking[0].items.filter(i => i.tag !== tagId);
                // Remove from exchanges
                appData.weekly.forEach(g => g.items = g.items.filter(i => i.tag !== tagId));
                appData.daily.forEach(g => g.items = g.items.filter(i => i.tag !== tagId));
                // Remove from customPrep
                if (appData.customPrep) appData.customPrep = appData.customPrep.filter(i => i.tag !== tagId);

                saveData();
                renderMenuManageList();
                renderMenuToggles();
                refreshAll();
            });
        }

        function renderBody(tbodyId, data, type) {
            const tbody = document.getElementById(tbodyId);
            tbody.innerHTML = '';
            if (!data) return;

            data.forEach(group => {
                const isAlwaysShow = ['shop', 'week', 'day'].includes(type);
                const activeItems = group.items.filter(item => isAlwaysShow || !item.tag || isTagActive(item.tag));
                if (activeItems.length === 0) return;

                const vRow = document.createElement('tr');
                vRow.className = 'village-row';
                vRow.innerHTML = `<td colspan="6">ğŸ“ ${group.village}</td>`;
                tbody.appendChild(vRow);

                // ì²´í¬ëœ í•­ëª© ì •ë ¬ (ì¤€ë¹„ë¬¼ ì™¸ì—ëŠ” ì •ë ¬í•˜ì§€ ì•ŠìŒ)
                // if (type === 'prep') ... (ì¤€ë¹„ë¬¼ì€ ë³„ë„ í•¨ìˆ˜ì—ì„œ ì²˜ë¦¬ì¤‘)
                // ë”°ë¼ì„œ renderBodyì—ì„œëŠ” ê¸°ë³¸ ìˆœì„œ ìœ ì§€

                activeItems.forEach((row, idx) => {
                    const tr = document.createElement('tr');
                    tr.draggable = true;
                    tr.ondragstart = handleDragStart;
                    tr.ondragover = handleDragOver;
                    tr.ondragleave = handleDragLeave;
                    tr.ondrop = handleDrop;
                    tr.ondragend = handleDragEnd;

                    let itemHtml = `
                        <div class="npc-container">
                            <div class="drag-handle">â ¿</div>
                            <div class="npc-info">
                                <div class="npc-name">${row.npc}</div>
                                <div class="item-desc">${row.item}</div>
                            </div>
                    `;

                    if (type === 'cook') {
                        itemHtml += `
                            <div class="row-actions">
                                <button class="action-btn btn-edit" draggable="false" onclick="event.stopPropagation(); openRolePopup('${row.id}', this)" title="ë‹´ë‹¹ ì„¤ì •">ğŸ‘¤</button>
                            </div>
                        `;
                    } else if (['shop', 'week', 'day'].includes(type)) {
                        // ê´€ë¦¬ ëª¨ë‹¬ë¡œ ë„˜ê¸°ëŠ”ê²Œ ì¢‹ìœ¼ë‚˜, ë¹ ë¥¸ ìˆ˜ì •ì„ ìœ„í•´ ì—°í•„ ë²„íŠ¼ ìœ ì§€
                        itemHtml += `
                            <div class="row-actions">
                                <button class="action-btn btn-edit" draggable="false" onclick="event.stopPropagation(); editSingleItem('${type}', '${group.village}', ${group.items.indexOf(row)})" title="ìˆ˜ì •">âœï¸</button>
                            </div>
                        `;
                    }
                    itemHtml += `</div>`;

                    let html = `<td>${itemHtml}</td>`;

                    charKeys.forEach(char => {
                        let disabled = false;
                        if (type === 'cook') {
                            let roles = getRole(row.tag, row.defaultRole);
                            if (!roles.includes('each') && !roles.includes(char)) disabled = true;
                        }
                        const id = `${type}_${char}_${row.id || row.npc}_${idx}`; // Unique ID including index
                        const isChecked = localStorage.getItem(id) === 'true';
                        if (disabled) html += `<td class="check-cell" style="opacity:0.2; cursor:default;">-</td>`;
                        else html += `<td class="check-cell ${isChecked ? 'checked' : ''}" onclick="toggleCheck('${id}')"><div class="check-box"></div></td>`;
                    });
                    tr.innerHTML = html;
                    tbody.appendChild(tr);
                });
            });
        }

        function openRolePopup(itemId, btn) {
            const existing = document.querySelector('.role-popup');
            if (existing) existing.remove();

            const itemDef = appData.cooking[0].items.find(i => i.id === itemId);
            let currentRoles = JSON.parse(localStorage.getItem(`role_${itemId}`)) || (itemDef?.defaultRole || ['each']);

            const popup = document.createElement('div');
            popup.className = 'role-popup show';
            // ìœ„ì¹˜ ì¡°ì •
            const rect = btn.getBoundingClientRect();
            popup.style.top = (rect.bottom + window.scrollY + 5) + 'px';
            popup.style.left = (rect.left + window.scrollX) + 'px';

            const opts = [{ v: 'each', l: 'ê°ì ì œì‘' }];
            appData.characters.forEach(c => opts.push({ v: c.id, l: c.name }));

            function renderOptions() {
                popup.innerHTML = '';
                opts.forEach(o => {
                    const div = document.createElement('div');
                    div.className = 'role-option';
                    const chk = document.createElement('input');
                    chk.type = 'checkbox';
                    chk.checked = currentRoles.includes(o.v);

                    div.style.backgroundColor = chk.checked ? '#eff6ff' : 'transparent';

                    div.onclick = (e) => {
                        e.stopPropagation();
                        // Logic
                        if (o.v === 'each') {
                            if (!currentRoles.includes('each')) currentRoles = ['each'];
                            else currentRoles = []; // Toggle off usually allowed? Or enforce one? Let's allow toggle off (empty).
                        } else {
                            if (currentRoles.includes('each')) currentRoles = []; // Clear 'each' if selecting specific
                            if (currentRoles.includes(o.v)) currentRoles = currentRoles.filter(r => r !== o.v);
                            else currentRoles.push(o.v);
                        }

                        // Save
                        if (currentRoles.length === 0 && o.v === 'each') currentRoles = []; // Empty allowed
                        localStorage.setItem(`role_${itemId}`, JSON.stringify(currentRoles));

                        // Re-render popup UI locally
                        renderOptions();
                        // Update Preps immediately
                        renderPrepGrid();
                        // Note: We don't refresh Table Body here to keep popup open. 
                        // Table checks will update on next refresh (e.g. closing popup or other action).
                    };

                    div.appendChild(chk);
                    div.appendChild(document.createTextNode(o.l));
                    popup.appendChild(div);
                });
            }
            renderOptions();

            document.body.appendChild(popup);

            // Close when clicking outside
            setTimeout(() => {
                document.addEventListener('click', function close(e) {
                    if (!popup.contains(e.target) && e.target !== btn) {
                        popup.remove();
                        document.removeEventListener('click', close);
                        refreshAll(); // Refresh table on close to update disabled states
                    }
                });
            }, 0);
        }



        function toggleCheck(id) {
            const isChecked = localStorage.getItem(id) === 'true';
            localStorage.setItem(id, !isChecked);
            refreshAll();
        }

        function toggleSection(header) {
            header.classList.toggle('collapsed');
        }

        function saveTabMemo(val) { localStorage.setItem('mabi_tab_memo', val); }
        function showSection(id, btn) {
            document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            btn.classList.add('active');
            window.scrollTo(0, 0);
        }

        function deleteMenu(tagId) {
            showConfirm('í•´ë‹¹ ë©”ë‰´ì™€ ì—°ë™ëœ ëª¨ë“  ë°ì´í„°ê°€ ì‚­ì œë©ë‹ˆë‹¤. ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?', () => {
                appData.menus = appData.menus.filter(m => m.id !== tagId);
                appData.cooking[0].items = appData.cooking[0].items.filter(i => i.tag !== tagId);
                appData.weekly.forEach(g => g.items = g.items.filter(i => i.tag !== tagId));
                appData.daily.forEach(g => g.items = g.items.filter(i => i.tag !== tagId));
                if (appData.customPrep) appData.customPrep = appData.customPrep.filter(i => i.tag !== tagId);
                saveData();
                refreshAll();
                renderMenuToggles();
                renderMenuManagerList();
            });
        }

        function openMenuManager() {
            renderMenuManagerList();
            document.getElementById('menu-manager-modal').classList.add('open');
        }
        function closeMenuManager() { document.getElementById('menu-manager-modal').classList.remove('open'); }
        function renderMenuManagerList() {
            const area = document.getElementById('menu-manage-list');
            area.innerHTML = '';
            appData.menus.forEach(tag => {
                const div = document.createElement('div');
                div.className = 'manage-item';
                div.innerHTML = `
                    <div class="manage-item-info">
                        <b>${tag.label}</b>
                    </div>
                    <div style="display:flex; gap:4px;">
                        <button class="btn-mini-del" style="background-color:#f3f4f6; color:#4b5563; border-color:#d1d5db;" onclick="openEditModal('${tag.id}'); closeMenuManager();">ìˆ˜ì •</button>
                        <button class="btn-mini-del" onclick="deleteMenu('${tag.id}')">ì‚­ì œ</button>
                    </div>
                `;
                area.appendChild(div);
            });
            if (appData.menus.length === 0) area.innerHTML = '<p style="padding:20px; text-align:center; color:#9ca3af;">ë©”ë‰´ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
        }
        function resetAll() {
            showConfirm('ì²´í¬ ìƒíƒœë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ì €ì¥ëœ ë©”ë‰´/ëª©ë¡ì€ ìœ ì§€ë©ë‹ˆë‹¤)', () => {
                Object.keys(localStorage).forEach(key => {
                    if (key.startsWith('prep_') ||
                        key.startsWith('role_') ||
                        key.startsWith('menu_') ||
                        key.startsWith('daily_') ||
                        key.startsWith('week_') ||
                        key.startsWith('cook_') ||
                        key.startsWith('shop_')) {
                        localStorage.removeItem(key);
                    }
                });
                // ë©”ë‰´ ìƒíƒœ ì´ˆê¸°í™” (ë¹„í™œì„±í™”)
                appData.menus.forEach(m => localStorage.setItem(`menu_${m.id}`, 'false'));

                location.reload();
            });
        }

        // --- ê°œë³„ í•­ëª© í¸ì§‘ ---
        function openSingleModal(type) {
            document.getElementById('single-modal-title').innerText = 'â• í•­ëª© ì¶”ê°€';
            document.getElementById('edit-type').value = type;
            document.getElementById('edit-group-village').value = '';
            document.getElementById('edit-row-idx').value = '';

            document.getElementById('single-npc').value = '';
            document.getElementById('single-item').value = '';

            if (type === 'day' || type === 'week') {
                document.getElementById('single-item').style.display = 'none';
                document.getElementById('exchange-edit-group').style.display = 'block';
                document.getElementById('ex-give-item').value = '';
                document.getElementById('ex-give-qty').value = '';
                document.getElementById('ex-get-item').value = '';
                document.getElementById('ex-get-qty').value = '';
            } else {
                document.getElementById('single-item').style.display = 'block';
                document.getElementById('exchange-edit-group').style.display = 'none';
            }

            document.getElementById('single-modal').classList.add('open');
        }

        function closeSingleModal() {
            document.getElementById('single-modal').classList.remove('open');
        }

        function editSingleItem(type, village, idx) {
            const list = type === 'shop' ? appData.shopping : (type === 'week' ? appData.weekly : appData.daily);
            const group = list.find(g => g.village === village);
            if (!group) return;
            const item = group.items[idx];
            if (!item) return;

            document.getElementById('single-modal-title').innerText = 'âœï¸ í•­ëª© ìˆ˜ì •';
            document.getElementById('edit-type').value = type;
            document.getElementById('edit-group-village').value = village;
            document.getElementById('edit-row-idx').value = idx;

            document.getElementById('single-village').value = village;
            document.getElementById('single-npc').value = item.npc || '';
            document.getElementById('single-item').value = item.item || '';

            // êµí™˜ ì „ìš© UI ì²˜ë¦¬ (ì¼ì¼/ì£¼ê°„)
            if (type === 'day' || type === 'week') {
                document.getElementById('exchange-edit-group').style.display = 'block';
                document.getElementById('single-item').style.display = 'none';

                const parts = item.item.split('â†’');
                if (parts.length === 2) {
                    const left = parts[0].trim();
                    const right = parts[1].trim();
                    const leftMatch = left.match(/(.*?)[\s,]+(\d+)ê°œ$/);
                    const rightMatch = right.match(/(.*?)[\s,]+(\d+)ê°œ$/);

                    if (leftMatch) {
                        document.getElementById('ex-give-item').value = leftMatch[1].replace(/,$/, '').trim();
                        document.getElementById('ex-give-qty').value = leftMatch[2];
                    } else {
                        document.getElementById('ex-give-item').value = left;
                        document.getElementById('ex-give-qty').value = '';
                    }
                    if (rightMatch) {
                        document.getElementById('ex-get-item').value = rightMatch[1].replace(/,$/, '').trim();
                        document.getElementById('ex-get-qty').value = rightMatch[2];
                    } else {
                        document.getElementById('ex-get-item').value = right;
                        document.getElementById('ex-get-qty').value = '';
                    }
                } else {
                    document.getElementById('ex-give-item').value = '';
                    document.getElementById('ex-give-qty').value = '';
                    document.getElementById('ex-get-item').value = '';
                    document.getElementById('ex-get-qty').value = '';
                }
            } else {
                document.getElementById('exchange-edit-group').style.display = 'none';
                document.getElementById('single-item').style.display = 'block';
            }

            document.getElementById('single-modal').classList.add('open');
        }

        function deleteSingleItem(type, village, idx) {
            // This is now handled by manager modal to avoid interaction issues
            const list = type === 'shop' ? appData.shopping : (type === 'week' ? appData.weekly : appData.daily);
            const group = list.find(g => g.village === village);
            if (group) {
                group.items.splice(idx, 1);
                if (group.items.length === 0) {
                    const gIdx = list.indexOf(group);
                    list.splice(gIdx, 1);
                }
                saveData();
                refreshAll();
            }
        }

        // --- ê´€ë¦¬ ëª¨ë‹¬ ë¡œì§ ---
        function openManageModal(type) {
            document.getElementById('manage-type').value = type;
            const title = type === 'shop' ? 'ğŸ›ï¸ ì£¼ê°„êµ¬ë§¤ ê´€ë¦¬' : (type === 'week' ? 'ğŸ“¦ ì£¼ê°„êµí™˜ ê´€ë¦¬' : 'ğŸ”„ ì¼ì¼êµí™˜ ê´€ë¦¬');
            document.getElementById('manager-modal-title').innerText = title;

            renderManageList();
            document.getElementById('manager-modal').classList.add('open');
        }

        function closeManagerModal() {
            document.getElementById('manager-modal').classList.remove('open');
        }

        function renderManageList() {
            const type = document.getElementById('manage-type').value;
            const list = type === 'shop' ? appData.shopping : (type === 'week' ? appData.weekly : appData.daily);
            const area = document.getElementById('manage-list');
            area.innerHTML = '';

            list.forEach(group => {
                group.items.forEach((item, idx) => {
                    const div = document.createElement('div');
                    div.className = 'manage-item';
                    div.innerHTML = `
                        <div class="manage-item-info">
                            <b>${item.npc}</b> [${group.village}]
                            <span>${item.item}</span>
                        </div>
                        <div style="display:flex; gap:5px;">
                            <button class="btn-mini-del" style="background:#e5e7eb; color:#374151; border-color:#d1d5db;" onclick="editSingleItem('${type}', '${group.village}', ${idx})">ìˆ˜ì •</button>
                            <button class="btn-mini-del" onclick="deleteManageItem('${type}', '${group.village}', ${idx})">ì‚­ì œ</button>
                        </div>
                    `;
                    area.appendChild(div);
                });
            });

            if (area.innerHTML === '') area.innerHTML = '<p style="padding:20px; text-align:center; color:#9ca3af;">í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
        }

        function deleteManageItem(type, village, idx) {
            showConfirm('ì´ í•­ëª©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?', () => {
                deleteSingleItem(type, village, idx);
                renderManageList();
            });
        }

        function saveSingleItem() {
            const type = document.getElementById('edit-type').value;
            const oldVillage = document.getElementById('edit-group-village').value;
            const idx = document.getElementById('edit-row-idx').value;

            const newVillage = document.getElementById('single-village').value;
            const npc = document.getElementById('single-npc').value.trim();
            const itemText = document.getElementById('single-item').value.trim();

            let finalItemText = itemText;
            // ì¼ì¼/ì£¼ê°„ êµí™˜ ëª¨ë‘ ì ìš©
            if (type === 'day' || type === 'week') {
                const dayItem = document.getElementById('ex-give-item').value.trim();
                const dayQty = document.getElementById('ex-give-qty').value.trim();
                const rewardItem = document.getElementById('ex-get-item').value.trim();
                const rewardQty = document.getElementById('ex-get-qty').value.trim();

                // ê°’ì´ í•˜ë‚˜ë¼ë„ ìˆìœ¼ë©´ êµí™˜ í˜•ì‹ìœ¼ë¡œ ì €ì¥ ì‹œë„
                if (dayItem || dayQty || rewardItem || rewardQty) {
                    finalItemText = `${dayItem} ${dayQty}ê°œ â†’ ${rewardItem} ${rewardQty}ê°œ`;
                }
            }

            if (!npc || !finalItemText) return alert('ëª¨ë“  ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');

            const list = type === 'shop' ? appData.shopping : (type === 'week' ? appData.weekly : appData.daily);

            // ìˆ˜ì • ëª¨ë“œì¸ ê²½ìš° ê¸°ì¡´ ìœ„ì¹˜ì—ì„œ ì œê±° (ë§ˆì„ì´ ë°”ë€” ìˆ˜ ìˆìœ¼ë¯€ë¡œ)
            if (oldVillage !== '' && idx !== '') {
                const oldGroup = list.find(g => g.village === oldVillage);
                if (oldGroup && oldGroup.items[idx]) {
                    oldGroup.items.splice(idx, 1);
                    if (oldGroup.items.length === 0) {
                        const gIdx = list.indexOf(oldGroup);
                        if (gIdx > -1) list.splice(gIdx, 1);
                    }
                }
            }

            // ìƒˆ ìœ„ì¹˜ì— ì¶”ê°€
            let group = list.find(g => g.village === newVillage);
            if (!group) {
                group = { village: newVillage, items: [] };
                list.push(group);
            }
            // ê°™ì€ ë§ˆì„ì´ë©´ ë§¨ ë’¤ë¡œ ê°€ëŠ”ê²Œ ì•„ë‹ˆë¼ ìˆ˜ì •ëœ ìœ„ì¹˜ í˜¹ì€ ì ì ˆí•œ ìœ„ì¹˜?
            // í˜„ì¬ ë¡œì§ì€ push (ë§¨ ë’¤). ë“œë˜ê·¸ë¡œ ì •ë ¬ ê°€ëŠ¥í•˜ë¯€ë¡œ í—ˆìš©.
            group.items.push({ npc, item: finalItemText });

            saveData();
            closeSingleModal();
            refreshAll();

            // ê´€ë¦¬ ëª¨ë‹¬ì´ ì—´ë ¤ìˆë‹¤ë©´ ê°±ì‹ 
            if (document.getElementById('manager-modal').classList.contains('open')) {
                renderManageList();
            }
        }

        function moveCookItem(idx, direction) {
            const list = appData.cooking[0].items;
            const newIdx = idx + direction;
            if (newIdx < 0 || newIdx >= list.length) return;

            // Swap
            const temp = list[idx];
            list[idx] = list[newIdx];
            list[newIdx] = temp;

            saveData();
            refreshAll();
        }

        // ì‚­ì œ ê¸°ëŠ¥ ì¶”ê°€ (í¸ì§‘ ëª¨ë‹¬ ë‚´)
        function deleteCurrentItem() {
            const type = document.getElementById('edit-type').value;
            const village = document.getElementById('edit-group-village').value;
            const idx = document.getElementById('edit-row-idx').value;

            if (village === '' || idx === '') return;

            showConfirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?', () => {
                deleteSingleItem(type, village, parseInt(idx));
                closeSingleModal();
                if (document.getElementById('manager-modal').classList.contains('open')) {
                    renderManageList();
                }
            });
        }

        // --- ë“œë˜ê·¸ ì•¤ ë“œë¡­ ---
        let dragSrcEl = null;

        function handleDragStart(e) {
            dragSrcEl = this;
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', ''); // Firefox fix
            this.classList.add('dragging');
        }

        function handleDragOver(e) {
            if (e.preventDefault) e.preventDefault();
            if (this === dragSrcEl) return false;

            // ë™ì¼í•œ ì„¹ì…˜(type) ë‚´ì—ì„œë§Œ ë“œë˜ê·¸ í—ˆìš©
            if (this.dataset.type !== dragSrcEl.dataset.type) return false;

            this.classList.add('drag-over');
            e.dataTransfer.dropEffect = 'move';
            return false;
        }

        function handleDragLeave(e) {
            this.classList.remove('drag-over');
        }

        function handleDrop(e) {
            if (e.stopPropagation) e.stopPropagation();
            if (dragSrcEl !== this) {
                const type = dragSrcEl.dataset.type;
                const srcVillage = dragSrcEl.dataset.village;
                const srcIdx = parseInt(dragSrcEl.dataset.index);
                const targetVillage = this.dataset.village;
                const targetIdx = parseInt(this.dataset.index);

                if (type !== this.dataset.type) return false;

                if (type === 'cook') {
                    const list = appData.cooking[0].items;
                    if (srcIdx < 0 || srcIdx >= list.length) return false;

                    const [srcItem] = list.splice(srcIdx, 1);
                    // ë‹¨ìˆœ ì‚½ì…: ì•„ë˜ë¡œ ë“œë˜ê·¸ ì‹œ íƒ€ê²Ÿ ë’¤ì—, ìœ„ë¡œ ë“œë˜ê·¸ ì‹œ íƒ€ê²Ÿ ì•ì— ìì—°ìŠ¤ëŸ½ê²Œ ë°°ì¹˜ë¨
                    list.splice(targetIdx, 0, srcItem);
                } else {
                    const list = type === 'shop' ? appData.shopping : (type === 'week' ? appData.weekly : appData.daily);
                    const srcGroup = list.find(g => g.village === srcVillage);
                    const targetGroup = list.find(g => g.village === targetVillage);

                    if (!srcGroup || !targetGroup) return false;

                    const [srcItem] = srcGroup.items.splice(srcIdx, 1);

                    if (srcGroup === targetGroup) {
                        targetGroup.items.splice(targetIdx, 0, srcItem);
                    } else {
                        // ë‹¤ë¥¸ ê·¸ë£¹ìœ¼ë¡œ ì´ë™
                        targetGroup.items.splice(targetIdx, 0, srcItem);
                        // ë¹ˆ ê·¸ë£¹ ì •ë¦¬
                        if (srcGroup.items.length === 0) {
                            const grpIdx = list.indexOf(srcGroup);
                            if (grpIdx > -1) list.splice(grpIdx, 1);
                        }
                    }
                }

                saveData();
                refreshAll();
            }
            return false;
        }

        function handleDragEnd(e) {
            this.classList.remove('dragging');
            const rows = document.querySelectorAll('tr');
            rows.forEach(row => row.classList.remove('drag-over'));
        }

        // --- í™•ì¸ ëª¨ë‹¬ ë¡œì§ ---
        let confirmCallback = null;
        function showConfirm(msg, callback) {
            document.getElementById('confirm-msg').innerText = msg;
            confirmCallback = callback;
            document.getElementById('confirm-modal').classList.add('open');
            document.getElementById('confirm-ok-btn').onclick = function () {
                if (confirmCallback) confirmCallback();
                closeConfirmModal();
            };
        }
        function closeConfirmModal() {
            document.getElementById('confirm-modal').classList.remove('open');
            confirmCallback = null;
        }

        init();
    </script>

</body>

</html>
